<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calendario de Turnos 2026</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
:root {
    --verde: rgb(146, 208, 80);
    --verde-fuerte: rgb(0, 176, 80);
    --naranja: rgb(255, 192, 0);
    --azul: rgb(0, 32, 96);
    --gris: rgb(200, 200, 200);
    --rojo: rgb(220, 53, 69);
    --rojo-vacaciones: rgb(255, 0, 0);
    --morado: rgb(155, 89, 182);
}
body { font-family: 'Segoe UI', sans-serif; background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%); min-height: 100vh; padding: 10px; }
.header { text-align: center; padding: 15px; color: #fff; }
.header h1 { font-size: 1.8rem; }
.filters-panel { background: rgba(255,255,255,0.1); border-radius: 12px; padding: 12px; margin-bottom: 12px; max-width: 1400px; margin-left: auto; margin-right: auto; }
.filters-row { display: flex; flex-wrap: wrap; gap: 12px; align-items: flex-end; justify-content: center; }
.filter-group { display: flex; flex-direction: column; gap: 4px; }
.filter-group label { color: #fff; font-size: 0.75rem; font-weight: 600; }
.filter-group select, .filter-group input { padding: 8px 12px; border: none; border-radius: 8px; font-size: 0.9rem; }
.filter-group input { min-width: 200px; }
.filter-group select { min-width: 280px; }
.filter-results-count { color: rgba(255,255,255,0.7); font-size: 0.7rem; margin-top: 2px; text-align: center; }
.employee-info { background: rgba(255,255,255,0.95); border-radius: 12px; padding: 12px 15px; margin-bottom: 12px; max-width: 1400px; margin-left: auto; margin-right: auto; display: none; }
.employee-info.active { display: block; }
.general-view-info { background: linear-gradient(145deg, #667eea, #764ba2); border-radius: 12px; padding: 12px 15px; margin-bottom: 12px; max-width: 1400px; margin-left: auto; margin-right: auto; color: white; text-align: center; display: none; }
.general-view-info h2 { font-size: 1.2rem; margin-bottom: 5px; }
.general-view-info p { font-size: 0.85rem; opacity: 0.9; }
.employee-badge { display: inline-block; padding: 4px 10px; border-radius: 15px; font-size: 0.75rem; font-weight: 600; margin-right: 5px; }
.badge-crew { background: #667eea; color: white; }
.badge-role { background: #27ae60; color: white; }
.legend { display: flex; justify-content: center; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 10px; max-width: 1400px; margin-left: auto; margin-right: auto; }
.legend-item { display: flex; align-items: center; gap: 4px; color: #fff; font-size: 0.65rem; padding: 4px 8px; background: rgba(0,0,0,0.2); border-radius: 10px; }
.legend-color { width: 14px; height: 14px; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-size: 0.5rem; font-weight: 700; }
.legend-hours { opacity: 0.7; font-size: 0.55rem; }
.controls { display: flex; justify-content: center; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
.btn { padding: 8px 14px; border: none; border-radius: 18px; cursor: pointer; font-size: 0.8rem; font-weight: 600; transition: all 0.3s ease; color: white; }
.btn-save { background: linear-gradient(145deg, #27ae60, #2ecc71); }
.btn-export { background: linear-gradient(145deg, #3498db, #2980b9); }
.btn-reload { background: linear-gradient(145deg, #f39c12, #e67e22); }
.btn-print { background: linear-gradient(145deg, #95a5a6, #7f8c8d); }
.btn-general { background: linear-gradient(145deg, #9b59b6, #8e44ad); }
.btn-general.active { background: linear-gradient(145deg, #667eea, #764ba2); box-shadow: 0 0 15px rgba(102,126,234,0.5); }
.btn-logout { background: linear-gradient(145deg, #e74c3c, #c0392b); }
.btn-user { background: linear-gradient(145deg, #3498db, #2980b9); }
.btn-ot { background: linear-gradient(145deg, #9b59b6, #8e44ad); }
.btn-vacaciones { background: linear-gradient(145deg, #00b894, #00cec9); }
.btn-my-calendar { background: linear-gradient(145deg, #27ae60, #2ecc71); }
.btn-my-calendar.active { background: linear-gradient(145deg, #1e8449, #27ae60); box-shadow: 0 0 15px rgba(39,174,96,0.5); }
.btn-attendance { background: linear-gradient(145deg, #e67e22, #d35400); }
.btn:hover { transform: translateY(-2px); }
.btn-view { background: rgba(255,255,255,0.15); border: 2px solid rgba(255,255,255,0.3); padding: 6px 12px; }
.btn-view.active { background: linear-gradient(145deg, #667eea, #764ba2); border-color: transparent; }
.btn-danger { background: linear-gradient(145deg, #e74c3c, #c0392b); }
.btn-warning { background: linear-gradient(145deg, #f39c12, #e67e22); }
.btn-small { padding: 5px 10px; font-size: 0.7rem; }
.btn-solicitudes { background: linear-gradient(145deg, #e91e63, #c2185b); }
.calendar-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; max-width: 1400px; margin: 0 auto; }
.calendar-grid.cols-4 { grid-template-columns: repeat(4, 1fr); }
.calendar-grid.cols-2 { grid-template-columns: repeat(2, 1fr); }
.month-card { background: rgba(255,255,255,0.98); border-radius: 12px; padding: 8px; box-shadow: 0 6px 25px rgba(0,0,0,0.2); }
.month-header { text-align: center; padding: 8px; margin: -8px -8px 8px -8px; background: linear-gradient(145deg, #667eea, #764ba2); border-radius: 12px 12px 0 0; color: white; }
.calendar-table { width: 100%; border-collapse: separate; border-spacing: 2px; table-layout: fixed; }
.calendar-table th { padding: 4px 2px; text-align: center; font-weight: 700; color: #555; font-size: 0.6rem; }
.calendar-table th:last-child { color: #e74c3c; }
.calendar-table th:nth-child(6) { color: #3498db; }
.calendar-table td { text-align: center; padding: 2px 1px; border-radius: 6px; font-size: 0.65rem; height: 42px; vertical-align: middle; position: relative; cursor: pointer; transition: transform 0.2s; overflow: hidden; }
.calendar-table td:not(.empty):hover { transform: scale(1.15); z-index: 10; box-shadow: 0 3px 10px rgba(0,0,0,0.3); }
.day-num { font-weight: 700; display: block; font-size: 0.75rem; line-height: 1.1; }
.shift-c, .shift-cw { background: linear-gradient(135deg, #e0e0e0, #bdbdbd) !important; color: #444 !important; border-left: 3px solid #757575; }
.shift-code { font-size: 0.55rem; font-weight: 700; display: block; line-height: 1.1; text-transform: uppercase; }
.shift-hours { font-size: 0.4rem; display: block; opacity: 0.8; line-height: 1; }
.shift-wm { background: linear-gradient(135deg, var(--verde), #7cb342) !important; color: #1a5c1a !important; border-left: 3px solid #2e7d32; }
.shift-m8 { background: linear-gradient(135deg, #81c784, var(--verde)) !important; color: #1a5c1a !important; border-left: 3px solid #43a047; }
.shift-m { background: var(--verde) !important; color: #1a5c1a !important; border-left: 3px solid #66bb6a; }
.shift-m-co { background: linear-gradient(135deg, #c8e6c9, #a5d6a7) !important; color: #2e7d32 !important; border-left: 3px solid #66bb6a; border-style: dashed; }
.shift-wt { background: linear-gradient(135deg, var(--naranja), #ffa000) !important; color: #5a4000 !important; border-left: 3px solid #ef6c00; }
.shift-t8 { background: linear-gradient(135deg, #ffca28, var(--naranja)) !important; color: #5a4000 !important; border-left: 3px solid #f57c00; }
.shift-t { background: var(--naranja) !important; color: #5a4000 !important; border-left: 3px solid #ffb300; }
.shift-t-co { background: linear-gradient(135deg, #fff3cd, #ffe082) !important; color: #5a4000 !important; border-left: 3px solid #ffb300; border-style: dashed; }
.shift-n8 { background: linear-gradient(135deg, var(--azul), #1a237e) !important; color: white !important; border-left: 3px solid #4a148c; }
.shift-n { background: linear-gradient(135deg, #303f9f, var(--azul)) !important; color: white !important; border-left: 3px solid #283593; }
.shift-nn { background: linear-gradient(135deg, #5c6bc0, #3949ab) !important; color: white !important; border-left: 3px solid #1a237e; }
.shift-n-co { background: linear-gradient(135deg, #7986cb, #5c6bc0) !important; color: white !important; border-left: 3px solid #3949ab; border-style: dashed; }
.shift-c, .shift-cw { background: linear-gradient(135deg, #e0e0e0, #bdbdbd) !important; color: #444 !important; border-left: 3px solid #757575; }
.shift-v, .shift-v25, .shift-v26 { background: linear-gradient(135deg, #ef5350, #e53935) !important; color: white !important; border-left: 3px solid #b71c1c; }
.shift-ap { background: linear-gradient(135deg, var(--verde-fuerte), #00c853) !important; color: white !important; border-left: 3px solid #1b5e20; }
.shift-tr { background: linear-gradient(135deg, #ff9800, #f57c00) !important; color: white !important; border-left: 3px solid #e65100; }
.shift-bm, .shift-bp { background: #e0e0e0 !important; color: #666 !important; border-left: 3px solid #9e9e9e; }
.ot-file-day { background: linear-gradient(135deg, #9b59b6, #8e44ad) !important; color: white !important; border: 2px solid #6c3483 !important; animation: pulse-ot 2s ease-in-out infinite; }
.ot-file-day .day-num { color: white !important; }
.ot-file-day .shift-code { color: #f5b7b1 !important; font-size: 0.5rem !important; }
.ot-file-day.user-signed { background: linear-gradient(135deg, #27ae60, #2ecc71) !important; border-color: #1e8449 !important; }
.ot-file-day.user-assigned { background: linear-gradient(135deg, #f39c12, #e67e22) !important; border-color: #d68910 !important; }
@keyframes pulse-ot { 0%, 100% { box-shadow: 0 0 5px rgba(155,89,182,0.5); } 50% { box-shadow: 0 0 15px rgba(155,89,182,0.8); } }
.empty { background: transparent; }
.libre { background: #f8f8f8; color: #ddd; }
.festivo { border: 2px solid var(--rojo) !important; }
.festivo::before { content: ''; position: absolute; top: 1px; right: 1px; width: 5px; height: 5px; background: var(--rojo); border-radius: 50%; }
.reducido::after { content: 'R'; position: absolute; bottom: 0; right: 1px; font-size: 0.4rem; color: #9b59b6; font-weight: bold; }
.general-day { background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%); }
.general-day:hover { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white !important; }
.general-day .day-num { color: #333; }
.general-day:hover .day-num { color: white; }
.weekend-sat { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); }
.weekend-sun { background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%); }
.alarm-morning { background: linear-gradient(135deg, var(--verde), #7cb342) !important; }
.alarm-afternoon { background: linear-gradient(135deg, var(--naranja), #ffa000) !important; }
.alarm-night { background: linear-gradient(135deg, var(--azul), #1a237e) !important; }
.alarm-morning-afternoon { animation: blink-morning-afternoon 1.2s ease-in-out infinite; }
.alarm-morning-night { animation: blink-morning-night 1.2s ease-in-out infinite; }
.alarm-afternoon-night { animation: blink-afternoon-night 1.2s ease-in-out infinite; }
.alarm-all { animation: blink-all 1.8s ease-in-out infinite; }
@keyframes blink-morning-afternoon { 0%,49%{background:linear-gradient(135deg,var(--verde),#7cb342);}50%,100%{background:linear-gradient(135deg,var(--naranja),#ffa000);} }
@keyframes blink-morning-night { 0%,49%{background:linear-gradient(135deg,var(--verde),#7cb342);}50%,100%{background:linear-gradient(135deg,var(--azul),#1a237e);} }
@keyframes blink-afternoon-night { 0%,49%{background:linear-gradient(135deg,var(--naranja),#ffa000);}50%,100%{background:linear-gradient(135deg,var(--azul),#1a237e);} }
@keyframes blink-all { 0%,32%{background:linear-gradient(135deg,var(--verde),#7cb342);}33%,65%{background:linear-gradient(135deg,var(--naranja),#ffa000);}66%,100%{background:linear-gradient(135deg,var(--azul),#1a237e);} }
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; justify-content: center; align-items: center; }
.modal-overlay.active { display: flex; }
.modal { background: white; padding: 20px; border-radius: 16px; max-width: 500px; width: 90%; text-align: center; max-height: 85vh; overflow-y: auto; }
.modal-large { max-width: 800px; }
.modal-xlarge { max-width: 95%; width: 1200px; }
.modal h3 { margin-bottom: 8px; color: #333; }
.festivo-badge { display: inline-block; background: var(--rojo); color: white; padding: 6px 12px; border-radius: 15px; margin-bottom: 10px; font-weight: 600; font-size: 0.8rem; }
.ot-badge { display: inline-block; background: linear-gradient(135deg, #9b59b6, #8e44ad); color: white; padding: 6px 12px; border-radius: 15px; margin-bottom: 10px; font-weight: 600; font-size: 0.8rem; }
.modal-section-title { font-size: 0.75rem; color: #888; margin: 12px 0 8px 0; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #eee; padding-bottom: 4px; }
.modal-buttons { display: grid; grid-template-columns: repeat(2,1fr); gap: 8px; margin-bottom: 12px; }
.modal-buttons-3col { display: grid; grid-template-columns: repeat(3,1fr); gap: 8px; margin-bottom: 12px; }
.modal-btn { padding: 12px 8px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; font-size: 0.85rem; display: flex; flex-direction: column; align-items: center; gap: 2px; transition: transform 0.2s; }
.modal-btn:hover { transform: scale(1.05); }
.modal-btn .btn-code { font-size: 1rem; }
.modal-btn .btn-hours { font-size: 0.65rem; opacity: 0.8; }
.modal-btn.btn-wm { background: linear-gradient(135deg,var(--verde),#7cb342); color: #1a5c1a; }
.modal-btn.btn-m8 { background: linear-gradient(135deg,#81c784,var(--verde)); color: #1a5c1a; }
.modal-btn.btn-m-co { background: linear-gradient(135deg,#c8e6c9,#a5d6a7); color: #2e7d32; border: 2px dashed #66bb6a; }
.modal-btn.btn-wt { background: linear-gradient(135deg,var(--naranja),#ffa000); color: #5a4000; }
.modal-btn.btn-t8 { background: linear-gradient(135deg,#ffca28,var(--naranja)); color: #5a4000; }
.modal-btn.btn-t-co { background: linear-gradient(135deg,#fff3cd,#ffe082); color: #5a4000; border: 2px dashed #ffb300; }
.modal-btn.btn-n8 { background: linear-gradient(135deg,var(--azul),#1a237e); color: white; }
.modal-btn.btn-n { background: linear-gradient(135deg,#303f9f,var(--azul)); color: white; }
.modal-btn.btn-nn { background: linear-gradient(135deg,#5c6bc0,#3949ab); color: white; }
.modal-btn.btn-n-co { background: linear-gradient(135deg,#7986cb,#5c6bc0); color: white; border: 2px dashed #3949ab; }
.modal-btn.btn-c { background: linear-gradient(135deg,#e0e0e0,#bdbdbd); color: #444; }
.modal-btn.btn-v { background: linear-gradient(135deg,#ef5350,#e53935); color: white; }
.modal-btn.btn-ap { background: linear-gradient(135deg,var(--verde-fuerte),#00c853); color: white; }
.modal-btn.btn-tr { background: linear-gradient(135deg,#ff9800,#f57c00); color: white; }
.modal-btn.btn-libre { background: #f5f5f5; color: #999; border: 2px dashed #ddd; }
.modal-close { padding: 8px 20px; background: #95a5a6; color: white; border: none; border-radius: 15px; cursor: pointer; font-weight: 600; }
.current-shift-display { background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
.current-shift-display .shift-label { font-size: 0.8rem; color: #666; margin-bottom: 5px; }
.current-shift-display .shift-info { display: flex; align-items: center; justify-content: center; gap: 10px; }
.current-shift-display .shift-badge-large { padding: 10px 20px; border-radius: 10px; font-weight: 700; font-size: 1.2rem; }
.current-shift-display .shift-time { font-size: 1rem; color: #333; }
.login-container { max-width: 400px; margin: 50px auto; padding: 30px; background: rgba(255,255,255,0.95); border-radius: 20px; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
.login-container h2 { color: #333; margin-bottom: 10px; }
.login-container p { color: #666; margin-bottom: 20px; font-size: 0.9rem; }
.login-container .login-icon { font-size: 4rem; margin-bottom: 15px; }
.login-container input { width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; margin-bottom: 10px; }
.login-container input:focus { border-color: #667eea; outline: none; }
.login-container .btn { width: 100%; padding: 12px; font-size: 1rem; margin-top: 10px; }
.login-status { padding: 10px; border-radius: 8px; margin-top: 10px; font-weight: 600; }
.login-status.error { background: #f8d7da; color: #721c24; }
.login-status.success { background: #d4edda; color: #155724; }
.login-security-note { margin-top: 20px; padding: 12px; background: #fff3cd; border-radius: 8px; font-size: 0.75rem; color: #856404; text-align: left; }
.login-security-note strong { display: block; margin-bottom: 5px; }
.user-info-bar { background: linear-gradient(145deg,#667eea,#764ba2); padding: 10px 20px; border-radius: 12px; margin-bottom: 12px; max-width: 1400px; margin-left: auto; margin-right: auto; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
.user-info-bar .user-details { color: white; }
.user-info-bar .user-name { font-weight: 700; font-size: 1.1rem; }
.user-info-bar .user-role { font-size: 0.8rem; opacity: 0.9; }
.user-info-bar .user-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 10px; font-size: 0.7rem; margin-left: 10px; }
.user-info-bar .user-badge.manager-badge { background: #e74c3c; }
.user-info-bar .user-actions { display: flex; gap: 8px; flex-wrap: wrap; }
.manager-info { background: linear-gradient(135deg,#667eea,#764ba2); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
.manager-info h4 { margin-bottom: 5px; }
.manager-info p { font-size: 0.85rem; opacity: 0.9; }
.manager-info .manager-role-badge { display: inline-block; background: rgba(255,255,255,0.2); padding: 3px 10px; border-radius: 10px; font-size: 0.75rem; margin-top: 5px; }
.panel-nav { display: flex; gap: 5px; margin-bottom: 15px; justify-content: center; flex-wrap: wrap; }
.panel-nav-btn { padding: 10px 16px; border: none; background: #eee; border-radius: 20px; cursor: pointer; font-weight: 600; font-size: 0.8rem; transition: all 0.2s; }
.panel-nav-btn:hover { background: #ddd; }
.panel-nav-btn.active { background: linear-gradient(135deg,#667eea,#764ba2); color: white; }
.panel-content { display: none; }
.panel-content.active { display: block; }
.password-section { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-top: 15px; }
.password-section h4 { margin-bottom: 10px; color: #333; }
.password-section input { margin: 5px auto; display: block; }
.password-status { display: inline-block; padding: 3px 10px; border-radius: 12px; font-size: 0.8rem; font-weight: 600; }
.password-status.default { background: #fff3cd; color: #856404; }
.password-status.custom { background: #d4edda; color: #155724; }
.password-summary-item { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #eee; }
.password-summary-item:last-child { border-bottom: none; }
.password-summary-item .count { font-weight: 700; font-size: 1.2rem; }
.password-summary-item .label { color: #666; font-size: 0.85rem; }
.import-panel { text-align: left; margin-top: 15px; }
.import-panel textarea { width: 100%; height: 200px; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-family: monospace; font-size: 0.75rem; resize: vertical; }
.import-panel .btn-row { display: flex; gap: 10px; margin-top: 10px; justify-content: center; flex-wrap: wrap; }
.import-info { background: #e7f3ff; border: 1px solid #b3d7ff; border-radius: 8px; padding: 10px; margin-bottom: 10px; font-size: 0.8rem; color: #004085; text-align: left; }
.stats-container { max-width: 1400px; margin: 20px auto; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 12px; }
.stats-title { color: #fff; text-align: center; margin-bottom: 12px; }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(80px,1fr)); gap: 8px; }
.stat-card { background: rgba(255,255,255,0.95); padding: 10px 6px; border-radius: 8px; text-align: center; }
.stat-number { font-size: 1.4rem; font-weight: 800; }
.stat-label { color: #666; font-size: 0.55rem; }
.notification { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%) translateY(100px); padding: 12px 20px; background: #27ae60; color: white; border-radius: 8px; font-weight: 600; transition: transform 0.3s ease; z-index: 2000; }
.notification.show { transform: translateX(-50%) translateY(0); }
.notification.error { background: #e74c3c; }
.data-status { text-align: center; padding: 5px; font-size: 0.7rem; }
.data-status.online { color: #7bed9f; }
.data-status.offline { color: #ff6b6b; }
.data-status.loading { color: #ffeaa7; }
.loading { text-align: center; padding: 50px; color: #fff; }
.loading-spinner { border: 4px solid rgba(255,255,255,0.3); border-top: 4px solid #fff; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px; }
@keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
.day-overview-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 15px; margin: 15px 0; }
.shift-column { background: #f8f9fa; border-radius: 12px; padding: 12px; min-height: 200px; }
.shift-column.column-alarm { background: #fff5f5 !important; border: 2px solid #e74c3c; }
.shift-column-header { text-align: center; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-weight: 700; font-size: 0.9rem; }
.shift-column-header.morning { background: linear-gradient(135deg,var(--verde),#7cb342); color: #1a5c1a; }
.shift-column-header.afternoon { background: linear-gradient(135deg,var(--naranja),#ffa000); color: #5a4000; }
.shift-column-header.night { background: linear-gradient(135deg,var(--azul),#1a237e); color: white; }
.shift-column-header.central { background: linear-gradient(135deg,#e0e0e0,#bdbdbd); color: #444; }
.shift-column-header.absent { background: linear-gradient(135deg,#e74c3c,#c0392b); color: white; }
.employee-list { max-height: 300px; overflow-y: auto; }
.employee-item { display: flex; align-items: center; justify-content: space-between; padding: 8px 10px; margin-bottom: 6px; background: white; border-radius: 8px; font-size: 0.8rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: all 0.2s; }
.employee-item:hover { transform: translateX(5px); box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
.employee-item .name { font-weight: 600; color: #333; }
.employee-item .crew { font-size: 0.6rem; color: #888; background: #eee; padding: 2px 6px; border-radius: 10px; margin-left: 5px; }
.employee-item .shift-badge { font-size: 0.65rem; font-weight: 700; padding: 3px 8px; border-radius: 4px; }
.shift-badge.morning { background: var(--verde); color: #1a5c1a; }
.shift-badge.afternoon { background: var(--naranja); color: #5a4000; }
.shift-badge.night { background: var(--azul); color: white; }
.shift-badge.central { background: var(--gris); color: #444; }
.column-count { text-align: center; font-size: 1.8rem; font-weight: 800; margin-bottom: 3px; }
.column-count.morning { color: #2e7d32; }
.column-count.afternoon { color: #e65100; }
.column-count.night { color: var(--azul); }
.column-count.central { color: #666; }
.column-count.absent { color: #e74c3c; }
.role-breakdown { text-align: center; font-size: 0.75rem; color: #555; margin-bottom: 10px; padding: 6px 10px; background: #fff; border-radius: 8px; border: 1px solid #eee; }
.no-employees { text-align: center; color: #999; font-style: italic; padding: 20px; font-size: 0.85rem; }
.day-summary { display: flex; justify-content: center; gap: 12px; margin-bottom: 15px; flex-wrap: wrap; }
.summary-item { display: flex; flex-direction: column; align-items: center; padding: 12px 16px; background: #f5f5f5; border-radius: 12px; min-width: 110px; }
.summary-item.has-alarm { background: #ffebee; border: 2px solid #e74c3c; }
.summary-item.absent-item { background: #ffebee; }
.summary-item .summary-icon { font-size: 1.2rem; margin-bottom: 3px; }
.summary-item .summary-total { font-weight: 800; font-size: 1.5rem; line-height: 1; }
.summary-item .summary-label { font-size: 0.7rem; color: #666; margin-top: 2px; }
.summary-item .summary-breakdown { font-size: 0.65rem; color: #888; margin-top: 4px; }
.summary-item .summary-breakdown .srme { color: #2e7d32; font-weight: 600; }
.summary-item .summary-breakdown .rmet { color: #1565c0; font-weight: 600; }
.summary-item.total-item { background: #e8f5e9; }
.summary-item.total-item .summary-total { color: #2e7d32; }
.bottom-sections { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px; padding-top: 15px; border-top: 2px dashed #ddd; }
.employee-item .role-detail { font-size: 0.65rem; padding: 2px 6px; border-radius: 8px; font-weight: 600; margin-left: 4px; }
.employee-item .role-detail.role-srme { background: #c8e6c9; color: #2e7d32; }
.employee-item .role-detail.role-rmet { background: #bbdefb; color: #1565c0; }
.employee-item .role-detail.role-app { background: #fff3e0; color: #e65100; }
.employee-item .role-detail.role-manager { background: #f3e5f5; color: #7b1fa2; }
.employee-item .role-detail.role-other { background: #f5f5f5; color: #616161; }
.employee-item .absence-type { font-size: 0.6rem; padding: 2px 6px; border-radius: 8px; font-weight: 600; }
.employee-item .absence-type.vac { background: #ffcdd2; color: #c62828; }
.employee-item .absence-type.ap { background: #c8e6c9; color: #2e7d32; }
.employee-item .absence-type.tr { background: #ffe0b2; color: #e65100; }
.employee-item .absence-type.baja { background: #e0e0e0; color: #424242; }
.role-summary { display: flex; flex-wrap: wrap; gap: 4px; justify-content: center; margin-bottom: 8px; }
.role-summary .role-chip { font-size: 0.6rem; padding: 2px 6px; border-radius: 10px; font-weight: 600; }
.role-summary .role-chip.srme { background: #c8e6c9; color: #2e7d32; }
.role-summary .role-chip.rmet { background: #bbdefb; color: #1565c0; }
.role-summary .role-chip.app { background: #fff3e0; color: #e65100; }
.role-summary .role-chip.manager { background: #f3e5f5; color: #7b1fa2; }
.role-summary .role-chip.warning { border: 2px solid #e74c3c; }
.ot-info-box { background: linear-gradient(135deg,#9b59b6,#8e44ad); color: white; padding: 15px; border-radius: 12px; margin-bottom: 15px; text-align: left; }
.ot-info-box h4 { margin-bottom: 8px; }
.ot-info-box p { font-size: 0.85rem; opacity: 0.9; margin-bottom: 5px; }
.ot-status-badge { display: inline-block; padding: 4px 12px; border-radius: 15px; font-size: 0.75rem; font-weight: 600; }
.ot-status-badge.open { background: #27ae60; }
.ot-status-badge.assigned { background: #f39c12; }
.ot-status-badge.closed { background: #95a5a6; }
.preference-selector { background: #f8f9fa; padding: 15px; border-radius: 12px; margin: 15px 0; }
.preference-selector h4 { margin-bottom: 10px; color: #333; font-size: 0.9rem; }
.preference-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 10px; background: white; border-radius: 8px; border: 2px solid #eee; }
.preference-row .pref-number { width: 30px; height: 30px; border-radius: 50%; background: #9b59b6; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; }
.preference-row select { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 6px; font-size: 0.9rem; }
.ot-requests-list { max-height: 300px; overflow-y: auto; margin: 15px 0; }
.ot-request-item { display: flex; align-items: center; justify-content: space-between; padding: 12px; margin-bottom: 8px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #9b59b6; }
.ot-request-item .request-info { flex: 1; }
.ot-request-item .request-name { font-weight: 700; color: #333; }
.ot-request-item .request-prefs { font-size: 0.8rem; color: #666; margin-top: 3px; }
.ot-request-item .request-prefs .pref-tag { display: inline-block; padding: 2px 8px; border-radius: 10px; margin-right: 5px; font-size: 0.7rem; font-weight: 600; }
.ot-request-item .request-prefs .pref-tag.morning { background: var(--verde); color: #1a5c1a; }
.ot-request-item .request-prefs .pref-tag.afternoon { background: var(--naranja); color: #5a4000; }
.ot-request-item .request-prefs .pref-tag.night { background: var(--azul); color: white; }
.ot-request-item .request-time { font-size: 0.7rem; color: #999; }
.ot-request-item .request-actions { display: flex; gap: 5px; }
.ot-request-item .assign-btn { padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; font-size: 0.7rem; font-weight: 600; }
.ot-request-item .assign-btn.morning { background: var(--verde); color: #1a5c1a; }
.ot-request-item .assign-btn.afternoon { background: var(--naranja); color: #5a4000; }
.ot-request-item .assign-btn.night { background: var(--azul); color: white; }
.ot-assignment-grid { display: grid; grid-template-columns: repeat(3,1fr); gap: 15px; margin: 15px 0; }
.ot-assignment-column { background: #f8f9fa; border-radius: 12px; padding: 12px; }
.ot-assignment-column .column-header { text-align: center; padding: 8px; border-radius: 8px; margin-bottom: 10px; font-weight: 700; font-size: 0.85rem; }
.ot-assignment-column .column-header.morning { background: linear-gradient(135deg,var(--verde),#7cb342); color: #1a5c1a; }
.ot-assignment-column .column-header.afternoon { background: linear-gradient(135deg,var(--naranja),#ffa000); color: #5a4000; }
.ot-assignment-column .column-header.night { background: linear-gradient(135deg,var(--azul),#1a237e); color: white; }
.ot-assigned-item { display: flex; align-items: center; justify-content: space-between; padding: 8px; margin-bottom: 5px; background: white; border-radius: 6px; font-size: 0.8rem; }
.ot-assigned-item .remove-btn { background: #e74c3c; color: white; border: none; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; font-size: 0.7rem; }
.new-ot-alert { background: linear-gradient(135deg,#e8daef,#d2b4de); border: 2px solid #9b59b6; border-radius: 12px; padding: 15px; margin-bottom: 12px; }
.new-ot-alert h4 { color: #6c3483; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
.new-ot-alert .ot-item { background: white; padding: 10px; border-radius: 8px; margin-bottom: 8px; border-left: 4px solid #9b59b6; cursor: pointer; transition: all 0.2s; }
.new-ot-alert .ot-item:hover { transform: translateX(5px); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.new-ot-alert .ot-item .ot-date { font-weight: 700; color: #333; }
.new-ot-alert .ot-item .ot-name { font-size: 0.85rem; color: #666; }
.vacaciones-section { background: linear-gradient(135deg,#e8f5e9,#c8e6c9); border-radius: 12px; padding: 15px; margin: 15px auto; max-width: 1400px; }
.vacaciones-section h3 { color: #2e7d32; margin-bottom: 15px; display: flex; align-items: center; gap: 8px; }
.vacaciones-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(140px,1fr)); gap: 10px; }
.vac-card { background: white; border-radius: 10px; padding: 12px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s; }
.vac-card:hover { transform: translateY(-2px); }
.vac-card .vac-value { font-size: 1.8rem; font-weight: 800; line-height: 1; }
.vac-card .vac-label { font-size: 0.7rem; color: #666; margin-top: 5px; line-height: 1.2; }
.vac-card.vac-anterior { border-left: 4px solid #9c27b0; }
.vac-card.vac-anterior .vac-value { color: #9c27b0; }
.vac-card.vac-actual { border-left: 4px solid #2196f3; }
.vac-card.vac-actual .vac-value { color: #2196f3; }
.vac-card.vac-ap { border-left: 4px solid #ff9800; }
.vac-card.vac-ap .vac-value { color: #ff9800; }
.vac-card.vac-total { border-left: 4px solid #4caf50; background: linear-gradient(135deg,#e8f5e9,#c8e6c9); }
.vac-card.vac-total .vac-value { color: #2e7d32; }
.vac-card.editable { cursor: pointer; position: relative; }
.vac-card.editable::after { content: '‚úèÔ∏è'; position: absolute; top: 5px; right: 5px; font-size: 0.6rem; opacity: 0.5; }
.vac-card.editable:hover::after { opacity: 1; }
.vac-subsection { margin-bottom: 15px; }
.vac-subsection-title { font-size: 0.75rem; color: #555; margin-bottom: 8px; padding-bottom: 5px; border-bottom: 1px dashed #ccc; display: flex; align-items: center; gap: 5px; }
.vac-edit-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; text-align: left; }
.vac-edit-group { background: #f8f9fa; padding: 12px; border-radius: 8px; }
.vac-edit-group label { display: block; font-size: 0.8rem; color: #555; margin-bottom: 5px; }
.vac-edit-group input { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 1rem; text-align: center; }
.vac-edit-group input:focus { border-color: #667eea; outline: none; }
.vac-edit-group.anterior { border-left: 4px solid #9c27b0; }
.vac-edit-group.actual { border-left: 4px solid #2196f3; }
.vac-edit-group.ap { border-left: 4px solid #ff9800; }
.vac-general-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; background: white; border-radius: 8px; overflow: hidden; }
.vac-general-table th { background: linear-gradient(135deg,#667eea,#764ba2); color: white; padding: 10px 8px; text-align: center; font-size: 0.7rem; }
.vac-general-table td { padding: 8px; text-align: center; border-bottom: 1px solid #eee; }
.vac-general-table tr:hover { background: #f5f5f5; }
.vac-general-table .emp-name { text-align: left; font-weight: 600; }
.vac-general-table .warning { color: #e74c3c; font-weight: 700; }
.vac-general-container { max-height: 400px; overflow-y: auto; }
.tools-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap: 15px; }
.tool-card { background: #f8f9fa; padding: 20px; border-radius: 12px; text-align: center; transition: transform 0.2s; }
.tool-card:hover { transform: translateY(-3px); }
.tool-card .tool-icon { font-size: 2.5rem; margin-bottom: 10px; }
.tool-card h5 { margin-bottom: 8px; color: #333; }
.tool-card p { font-size: 0.8rem; color: #666; margin-bottom: 15px; line-height: 1.4; }
.tool-card .btn { width: 100%; }
.general-stats-grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(100px,1fr)); gap: 10px; }
.general-stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; }
.general-stat-card .stat-value { font-size: 1.8rem; font-weight: 800; }
.general-stat-card .stat-name { font-size: 0.7rem; color: #666; margin-top: 3px; }
.alerts-container { max-width: 1400px; margin: 0 auto 12px auto; }
.hidden { display: none !important; }
.print-only { display: none; }
/* ATTENDANCE SHEET */
.att-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.88); z-index: 1500; overflow-y: auto; padding: 15px; }
.att-overlay.active { display: block; }
.att-container { background: white; border-radius: 16px; max-width: 980px; margin: 0 auto; overflow: hidden; box-shadow: 0 20px 60px rgba(0,0,0,0.5); }
.att-topbar { background: linear-gradient(135deg, #1a1a2e, #0f3460); color: white; padding: 14px 18px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 10px; }
.att-topbar-left h2 { font-size: 1rem; margin-bottom: 3px; }
.att-topbar-left p { font-size: 0.75rem; color: #90b8f8; }
.att-topbar-right { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
.att-week-select { padding: 7px 11px; border: none; border-radius: 8px; font-size: 0.82rem; font-weight: 600; min-width: 230px; cursor: pointer; }
.att-btn { padding: 7px 13px; border: none; border-radius: 10px; cursor: pointer; font-size: 0.78rem; font-weight: 700; color: white; transition: transform 0.2s; }
.att-btn:hover { transform: translateY(-1px); }
.att-btn-print { background: linear-gradient(145deg, #9b59b6, #8e44ad); }
.att-btn-close { background: rgba(255,255,255,0.2); }
.att-body { padding: 16px; }
.att-info-box { border-radius: 8px; padding: 10px 14px; margin-bottom: 14px; font-size: 0.8rem; font-weight: 600; border-left: 4px solid; }
.att-info-lunes { background: #eef2ff; color: #3333aa; border-color: #667eea; }
.att-info-otros { background: #fff8e1; color: #664400; border-color: #f39c12; }
.att-section { margin-bottom: 14px; border-radius: 10px; overflow: hidden; border: 1px solid #e5e5e5; page-break-inside: avoid; }
.att-sec-head { padding: 9px 14px; font-weight: 700; font-size: 0.83rem; display: flex; align-items: center; gap: 8px; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
.att-sec-badge { margin-left: auto; font-size: 0.68rem; font-weight: 400; opacity: 0.85; }
.att-head-manana { background: rgb(146,208,80); color: #1a5c1a; }
.att-head-tarde { background: rgb(255,192,0); color: #5a4000; }
.att-head-central { background: rgb(200,200,200); color: #333; }
.att-head-noche { background: rgb(0,32,96); color: white; }
.att-head-otros { background: #667eea; color: white; }
.att-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
.att-table th { background: #f5f5f5; padding: 6px 10px; text-align: left; font-size: 0.68rem; color: #666; border-bottom: 1px solid #ddd; }
.att-table td { padding: 7px 10px; border-bottom: 1px solid #f0f0f0; vertical-align: middle; }
.att-table tr:last-child td { border-bottom: none; }
.att-table tr:hover td { background: #fafbff; }
.att-td-login { font-family: monospace; font-weight: 700; color: #667eea; font-size: 0.72rem; }
.att-td-name { font-weight: 600; color: #222; }
.att-td-crew { display: inline-block; background: #667eea; color: white; padding: 2px 7px; border-radius: 8px; font-size: 0.62rem; }
.att-td-role { display: inline-block; background: #27ae60; color: white; padding: 2px 7px; border-radius: 8px; font-size: 0.62rem; }
.att-td-shift { font-weight: 700; font-size: 0.72rem; text-align: center; }
.att-td-day { color: #888; font-size: 0.7rem; }
.att-firma-cell { width: 135px; }
.att-firma-box { border: 1px solid #bbb; border-radius: 4px; height: 30px; width: 125px; }
.att-empty { text-align: center; padding: 14px; color: #bbb; font-size: 0.78rem; font-style: italic; }
@media print {
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    @page { size: A4 portrait; margin: 8mm; }
}
body.att-printing * { visibility: hidden; }
body.att-printing .att-overlay, body.att-printing .att-overlay * { visibility: visible; }
body.att-printing .att-overlay { position: absolute !important; top: 0; left: 0; width: 100%; background: white !important; padding: 0 !important; overflow: visible !important; display: block !important; }
body.att-printing .att-topbar-right { display: none !important; }
body.att-printing .att-container { border-radius: 0 !important; box-shadow: none !important; max-width: 100% !important; }
body.att-printing .att-section { page-break-inside: avoid; }
@media (max-width: 1000px) {
    .calendar-grid { grid-template-columns: repeat(2,1fr); }
    .day-overview-grid { grid-template-columns: 1fr; }
    .ot-assignment-grid { grid-template-columns: 1fr; }
    .bottom-sections { grid-template-columns: 1fr; }
}
@media (max-width: 600px) {
    .calendar-grid { grid-template-columns: 1fr; }
    .filters-row { flex-direction: column; }
    .filter-group select, .filter-group input { min-width: 100%; width: 100%; }
    .modal-buttons { grid-template-columns: 1fr; }
    .modal-buttons-3col { grid-template-columns: 1fr; }
    .user-info-bar { flex-direction: column; text-align: center; }
    .bottom-sections { grid-template-columns: 1fr; }
    .vac-edit-grid { grid-template-columns: 1fr; }
    .vacaciones-grid { grid-template-columns: repeat(2,1fr); }
    .tools-grid { grid-template-columns: 1fr; }
    .att-topbar { flex-direction: column; }
    .att-week-select { min-width: 100%; }
}
@media print {
    * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
    @page { size: A4 portrait; margin: 8mm; }
    body { background: white !important; padding: 0 !important; }
    .header, .filters-panel, .controls, .stats-container, .modal-overlay, .notification, .data-status, .user-info-bar, .alerts-container, .vacaciones-section, .general-view-info, .legend, #loginScreen { display: none !important; }
    .employee-info { display: block !important; background: white !important; border: 2px solid #333 !important; }
    .print-only { display: block !important; }
    .calendar-grid { display: grid !important; grid-template-columns: repeat(3,1fr) !important; gap: 6px !important; }
    .month-card { background: white !important; border: 1px solid #ccc !important; box-shadow: none !important; page-break-inside: avoid !important; }
    .month-header { background: linear-gradient(135deg,#667eea,#764ba2) !important; }
    .calendar-table td { height: 24px !important; font-size: 5pt !important; }
    .day-num { font-size: 6pt !important; }
    .shift-code { font-size: 4pt !important; }
    .shift-hours { display: none !important; }
    .shift-wm { background: rgb(146,208,80) !important; color: #1a5c1a !important; }
    .shift-m8 { background: rgb(180,220,140) !important; color: #1a5c1a !important; }
    .shift-wt { background: rgb(255,192,0) !important; color: #5a4000 !important; }
    .shift-t8 { background: rgb(255,210,80) !important; color: #5a4000 !important; }
    .shift-n8 { background: rgb(0,32,96) !important; color: white !important; }
    .shift-n { background: rgb(48,63,159) !important; color: white !important; }
    .shift-c, .shift-cw { background: rgb(200,200,200) !important; }
    .shift-v, .shift-v25, .shift-v26 { background: rgb(239,83,80) !important; color: white !important; }
    .shift-ap { background: rgb(0,176,80) !important; color: white !important; }
}
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
    <div class="login-container">
        <div class="login-icon">üîê</div>
        <h2>Calendario de Turnos 2026</h2>
        <p>Introduce tus credenciales para acceder</p>
        <div id="loginLoading" class="hidden">
            <div class="loading-spinner" style="border-color:#667eea;border-top-color:#764ba2;"></div>
            <p style="color:#666;">Cargando datos...</p>
        </div>
        <div id="loginForm">
            <input type="text" id="loginInput" placeholder="üë§ Tu login..." autocomplete="off" onkeypress="if(event.key==='Enter')document.getElementById('loginPassword').focus()">
            <input type="password" id="loginPassword" placeholder="üîë Contrase√±a..." autocomplete="off" onkeypress="if(event.key==='Enter')attemptLogin()">
            <div id="loginStatus" class="login-status hidden"></div>
            <button class="btn btn-save" onclick="attemptLogin()">üöÄ Entrar</button>
        </div>
        <div class="login-security-note">
            <strong>üîí Acceso Seguro</strong>
            Debes conocer tu login exacto para acceder.<br><br>
            <span style="font-size:0.7rem;">Contrase√±a por defecto: <strong>1234</strong></span>
        </div>
    </div>
</div>

<!-- APP -->
<div id="mainApp" class="hidden">
    <div class="header">
        <h1>üìÖ Calendario de Turnos 2026</h1>
        <p style="color:#a0a0a0;font-size:0.85rem;">Dos Hermanas, Sevilla</p>
        <div class="employee-count" id="employeeCount"></div>
        <div class="data-status" id="dataStatus">Conectando...</div>
    </div>

    <div class="user-info-bar" id="userInfoBar">
        <div class="user-details">
            <span class="user-name" id="loggedUserName">Usuario</span>
            <span class="user-badge" id="loggedUserRole">ROL</span>
            <span class="user-badge manager-badge hidden" id="managerBadge">üëë MANAGER</span>
            <div class="user-role" id="loggedUserCrew">CREW</div>
        </div>
        <div class="user-actions">
            <button class="btn btn-user" onclick="openUserSettingsModal()">‚öôÔ∏è Mi Cuenta</button>
            <button class="btn btn-logout" onclick="logout()">üö™ Salir</button>
        </div>
    </div>

    <div id="alertsContainer" class="alerts-container hidden">
        <div id="newOtAlertBox" class="new-ot-alert hidden">
            <h4>üîß Nuevos d√≠as OT FILE disponibles</h4>
            <div id="newOtAlertList"></div>
            <button class="btn btn-small btn-ot" onclick="dismissOtAlert()" style="margin-top:10px;">‚úì Entendido</button>
        </div>
    </div>

    <div class="filters-panel hidden" id="filtersPanel">
        <div class="filters-row">
            <div class="filter-group">
                <label>üîç Buscar Empleado:</label>
                <input type="text" id="searchEmployee" placeholder="Nombre, login o crew..." oninput="filterAndUpdateEmployeeList()">
            </div>
            <div class="filter-group">
                <label>üë§ Seleccionar:</label>
                <select id="filterEmployee" onchange="selectEmployee()">
                    <option value="">-- Vista General --</option>
                </select>
                <div class="filter-results-count" id="filterResultsCount"></div>
            </div>
        </div>
    </div>

    <div class="general-view-info" id="generalViewInfo">
        <h2>üìä Vista General del Equipo</h2>
        <p>Pulsa en cualquier d√≠a para ver qui√©n trabaja en cada turno</p>
    </div>

    <div class="employee-info" id="employeeInfo">
        <h2 id="employeeName">Nombre</h2>
        <span class="employee-badge badge-crew" id="employeeCrew">CREW</span>
        <span class="employee-badge badge-role" id="employeeRole">ROLE</span>
        <span style="color:#666;margin-left:8px;font-size:0.8rem;">Login: <strong id="employeeLogin">LOGIN</strong></span>
    </div>

    <div class="legend">
        <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,var(--verde),#7cb342)">WM</div><span><b>WM</b> <span class="legend-hours">Ma√±ana Larga</span></span></div>
        <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#81c784,var(--verde))">M8</div><span><b>M8</b> <span class="legend-hours">Ma√±ana 8h</span></span></div>
        <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,var(--naranja),#ffa000)">WT</div><span><b>WT</b> <span class="legend-hours">Tarde Larga</span></span></div>
        <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#ffca28,var(--naranja))">T8</div><span><b>T8</b> <span class="legend-hours">Tarde 8h</span></span></div>
        <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,var(--azul),#1a237e)">N8</div><span><b>N8</b> <span class="legend-hours">Noche 8h</span></span></div>
        <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#303f9f,var(--azul))">N</div><span><b>N</b> <span class="legend-hours">Noche</span></span></div>
        <div class="legend-item"><div class="legend-color" style="background:var(--gris)">C</div><span><b>C</b> Central</span></div>
        <div class="legend-item"><div class="legend-color" style="background:var(--rojo-vacaciones)">V</div><span><b>V</b> Vacaciones</span></div>
        <div class="legend-item"><div class="legend-color" style="background:var(--verde-fuerte)">AP</div><span><b>AP</b> Asuntos P.</span></div>
        <div class="legend-item"><div class="legend-color" style="background:linear-gradient(135deg,#9b59b6,#8e44ad)">OT</div><span><b>OT</b> D√≠a OT FILE</span></div>
        <div class="legend-item"><div class="legend-color" style="background:var(--rojo);border-radius:50%"></div><span>Festivo</span></div>
    </div>

    <div class="controls">
        <button class="btn btn-my-calendar active" id="btnMyCalendar" onclick="showMyCalendar()">üìÖ Mi Calendario</button>
        <button class="btn btn-general" id="btnGeneral" onclick="showGeneralView()">üë• Vista General</button>
        <button class="btn btn-attendance" onclick="openAttendance()">üìã Attendance</button>
        <button class="btn btn-print" onclick="printCalendar()">üñ®Ô∏è Imprimir</button>
        <button class="btn btn-user hidden" id="btnManagerPanel" onclick="openManagerModal()">üëë Panel Manager</button>
        <button class="btn btn-reload" onclick="reloadFromCloud()">üîÑ Recargar</button>
        <span style="width:10px"></span>
        <button class="btn btn-view" onclick="setView(4,this)">4</button>
        <button class="btn btn-view active" onclick="setView(3,this)">3</button>
        <button class="btn btn-view" onclick="setView(2,this)">2</button>
    </div>

    <div class="calendar-grid" id="calendarGrid">
        <div class="loading"><div class="loading-spinner"></div><p>Cargando datos...</p></div>
    </div>

    <div id="vacacionesSectionContainer"></div>

    <div class="stats-container" id="statsContainer" style="display:none;">
        <h3 class="stats-title">üìä Resumen</h3>
        <div class="stats-grid" id="statsGrid"></div>
    </div>

    <div class="print-only print-footer" id="printFooter">
        <h4>üìã LEYENDA DE TURNOS</h4>
        <div style="font-size:7pt;display:grid;grid-template-columns:repeat(4,1fr);gap:3px;">
            <span>WM=Ma√±ana Larga</span><span>M8=Ma√±ana 8h</span><span>WT=Tarde Larga</span><span>T8=Tarde 8h</span>
            <span>N8=Noche 8h</span><span>N=Noche</span><span>C=Central</span><span>V=Vacaciones</span>
            <span>AP=Asuntos Propios</span><span>TR=Formaci√≥n</span><span>OT=OT FILE</span><span>‚óè=Festivo</span>
        </div>
        <div style="margin-top:6px;font-size:6pt;color:#666;text-align:center;">
            Calendario de Turnos 2026 - Dos Hermanas, Sevilla | Generado el <span id="printDate"></span>
        </div>
    </div>
</div>

<!-- MODALES -->
<div class="modal-overlay" id="editModal">
    <div class="modal">
        <h3 id="modalTitle">D√≠a</h3>
        <div id="festivoBadge" class="festivo-badge" style="display:none;"></div>
        <div class="current-shift-display" id="currentShiftDisplay">
            <div class="shift-label">Turno actual:</div>
            <div class="shift-info">
                <span class="shift-badge-large" id="currentShiftBadge">-</span>
                <span class="shift-time" id="currentShiftTime"></span>
            </div>
        </div>
        <div id="managerEditSection" style="display:none;">
            <p style="font-size:0.8rem;color:#666;margin-bottom:10px;">Selecciona el nuevo turno:</p>
            <div class="modal-section-title">‚òÄÔ∏è Turnos de Ma√±ana</div>
            <div class="modal-buttons-3col">
                <button class="modal-btn btn-wm" onclick="setShift('wm')"><span class="btn-code">WM</span><span class="btn-hours">06:00-15:10</span></button>
                <button class="modal-btn btn-m8" onclick="setShift('m8')"><span class="btn-code">M8</span><span class="btn-hours">06:00-14:10</span></button>
                <button class="modal-btn btn-m-co" onclick="setShift('m-co')"><span class="btn-code">M-CO</span><span class="btn-hours">08:00-13:00</span></button>
            </div>
            <div class="modal-section-title">üåÖ Turnos de Tarde</div>
            <div class="modal-buttons-3col">
                <button class="modal-btn btn-wt" onclick="setShift('wt')"><span class="btn-code">WT</span><span class="btn-hours">14:00-23:10</span></button>
                <button class="modal-btn btn-t8" onclick="setShift('t8')"><span class="btn-code">T8</span><span class="btn-hours">14:00-22:10</span></button>
                <button class="modal-btn btn-t-co" onclick="setShift('t-co')"><span class="btn-code">T-CO</span><span class="btn-hours">13:00-18:00</span></button>
            </div>
            <div class="modal-section-title">üåô Turnos de Noche</div>
            <div class="modal-buttons">
                <button class="modal-btn btn-n8" onclick="setShift('n8')"><span class="btn-code">N8</span><span class="btn-hours">22:00-06:10</span></button>
                <button class="modal-btn btn-n" onclick="setShift('n')"><span class="btn-code">N</span><span class="btn-hours">22:00-06:30</span></button>
                <button class="modal-btn btn-nn" onclick="setShift('nn')"><span class="btn-code">NN</span><span class="btn-hours">00:00-06:30</span></button>
                <button class="modal-btn btn-n-co" onclick="setShift('n-co')"><span class="btn-code">N-CO</span><span class="btn-hours">23:00-04:00</span></button>
            </div>
            <div class="modal-section-title">üìã Otros</div>
            <div class="modal-buttons">
                <button class="modal-btn btn-c" onclick="setShift('c')"><span class="btn-code">C</span><span class="btn-hours">Central</span></button>
                <button class="modal-btn btn-v" onclick="setShift('v')"><span class="btn-code">V</span><span class="btn-hours">Vacaciones</span></button>
                <button class="modal-btn btn-ap" onclick="setShift('ap')"><span class="btn-code">AP</span><span class="btn-hours">Asuntos P.</span></button>
                <button class="modal-btn btn-tr" onclick="setShift('tr')"><span class="btn-code">TR</span><span class="btn-hours">Formaci√≥n</span></button>
            </div>
            <div class="modal-buttons" style="margin-top:10px;">
                <button class="modal-btn btn-libre" onclick="setShift('')" style="grid-column:span 2;"><span class="btn-code">LIBRE</span></button>
            </div>
        </div>
        <div id="noManagerMessage" style="color:#666;padding:10px;font-size:0.85rem;">
            üîí Solo los <strong>Managers</strong> pueden editar turnos
        </div>
        <div style="margin-top:15px;">
            <button class="modal-close" onclick="closeModal()">Cerrar</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="dayOverviewModal">
    <div class="modal modal-xlarge">
        <h3 id="dayOverviewTitle">üìÖ D√≠a</h3>
        <div id="dayOverviewFestivo" class="festivo-badge" style="display:none;"></div>
        <div class="day-summary" id="daySummary"></div>
        <div class="day-overview-grid">
            <div class="shift-column" id="columnMorning"><div class="shift-column-header morning">‚òÄÔ∏è MA√ëANA</div><div class="column-count morning" id="countMorning">0</div><div class="role-breakdown" id="roleBreakdownMorning"></div><div class="employee-list" id="listMorning"></div></div>
            <div class="shift-column" id="columnAfternoon"><div class="shift-column-header afternoon">üåÖ TARDE</div><div class="column-count afternoon" id="countAfternoon">0</div><div class="role-breakdown" id="roleBreakdownAfternoon"></div><div class="employee-list" id="listAfternoon"></div></div>
            <div class="shift-column" id="columnNight"><div class="shift-column-header night">üåô NOCHE</div><div class="column-count night" id="countNight">0</div><div class="role-breakdown" id="roleBreakdownNight"></div><div class="employee-list" id="listNight"></div></div>
        </div>
        <div class="bottom-sections">
            <div class="shift-column" id="columnCentral"><div class="shift-column-header central">üè¢ CENTRAL</div><div class="column-count central" id="countCentral">0</div><div class="role-breakdown" id="roleBreakdownCentral"></div><div class="employee-list" id="listCentral"></div></div>
            <div class="shift-column" id="columnAbsent"><div class="shift-column-header absent">üè† AUSENCIAS</div><div class="column-count absent" id="countAbsent">0</div><div class="role-breakdown" id="roleBreakdownAbsent"></div><div class="employee-list" id="listAbsent"></div></div>
        </div>
        <button class="modal-close" onclick="closeDayOverviewModal()" style="margin-top:15px;">Cerrar</button>
    </div>
</div>

<div class="modal-overlay" id="otFileModal">
    <div class="modal modal-large">
        <h3 id="otFileModalTitle">üîß D√≠a OT FILE</h3>
        <div class="ot-badge">OT FILE</div>
        <div class="ot-info-box"><h4 id="otFileName">D√≠a OT</h4><p id="otFileDesc"></p><p><strong>Creado por:</strong> <span id="otFileCreator"></span></p><span class="ot-status-badge" id="otFileStatus">Abierto</span></div>
        <div id="otSignupSection">
            <div class="preference-selector">
                <h4>üìù Indica tus preferencias de turno</h4>
                <div id="preferencesList">
                    <div class="preference-row"><span class="pref-number">1</span><select id="pref1"><option value="">-- Selecciona --</option><option value="morning">‚òÄÔ∏è Ma√±ana</option><option value="afternoon">üåÖ Tarde</option><option value="night">üåô Noche</option></select></div>
                    <div class="preference-row"><span class="pref-number">2</span><select id="pref2"><option value="">-- Opcional --</option><option value="morning">‚òÄÔ∏è Ma√±ana</option><option value="afternoon">üåÖ Tarde</option><option value="night">üåô Noche</option></select></div>
                    <div class="preference-row"><span class="pref-number">3</span><select id="pref3"><option value="">-- Opcional --</option><option value="morning">‚òÄÔ∏è Ma√±ana</option><option value="afternoon">üåÖ Tarde</option><option value="night">üåô Noche</option></select></div>
                </div>
                <textarea id="otSignupComment" placeholder="Comentario opcional..." style="width:100%;padding:10px;border:1px solid #ddd;border-radius:8px;margin-top:10px;height:60px;"></textarea>
                <div style="margin-top:15px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
                    <button class="btn btn-save" onclick="submitOtSignup()">‚úÖ Apuntarme</button>
                    <button class="btn btn-danger" id="btnCancelSignup" onclick="cancelOtSignup()" style="display:none;">‚ùå Cancelar</button>
                </div>
            </div>
            <div id="currentUserSignup" style="display:none;background:#e8f5e9;padding:15px;border-radius:12px;margin:15px 0;"><h4 style="color:#2e7d32;">‚úÖ Ya est√°s apuntado</h4><p id="currentUserPrefs" style="font-size:0.9rem;color:#333;"></p></div>
        </div>
        <div class="modal-section-title">üë• Personas apuntadas (<span id="otSignupCount">0</span>)</div>
        <div class="ot-requests-list" id="otRequestsList"><div class="no-employees">Nadie se ha apuntado todav√≠a</div></div>
        <div id="otAssignmentsSection" style="display:none;"><div class="modal-section-title">üìã Asignaci√≥n Final</div><div class="ot-assignment-grid" id="otAssignmentGrid"></div></div>
        <button class="modal-close" onclick="closeOtFileModal()" style="margin-top:15px;">Cerrar</button>
    </div>
</div>

<div class="modal-overlay" id="otManagerModal">
    <div class="modal modal-large">
        <h3>üîß Gestionar D√≠as OT FILE</h3>
        <div class="panel-nav">
            <button class="panel-nav-btn active" onclick="switchOtPanel('create',this)">‚ûï Crear OT</button>
            <button class="panel-nav-btn" onclick="switchOtPanel('list',this)">üìã Ver Todos</button>
            <button class="panel-nav-btn" onclick="switchOtPanel('assign',this)">üë• Asignar</button>
        </div>
        <div id="ot-panel-create" class="panel-content active">
            <div class="import-info"><strong>üìå Crear nuevo d√≠a OT FILE</strong><br>Al crear un OT, todos los usuarios ver√°n una notificaci√≥n al entrar.</div>
            <div style="margin:15px 0;"><label style="display:block;margin-bottom:5px;font-weight:600;">üìÖ Fecha:</label><input type="date" id="otNewDate" style="padding:10px;border:2px solid #ddd;border-radius:8px;font-size:1rem;width:100%;max-width:250px;"></div>
            <div style="margin:15px 0;"><label style="display:block;margin-bottom:5px;font-weight:600;">üìù Nombre:</label><input type="text" id="otNewName" placeholder="Ej: Reparaci√≥n L√≠nea A..." style="padding:10px;border:2px solid #ddd;border-radius:8px;font-size:1rem;width:100%;"></div>
            <div style="margin:15px 0;"><label style="display:block;margin-bottom:5px;font-weight:600;">üí¨ Notas:</label><textarea id="otNewNotes" placeholder="Informaci√≥n adicional..." style="width:100%;padding:10px;border:2px solid #ddd;border-radius:8px;height:80px;"></textarea></div>
            <button class="btn btn-save" onclick="createOtDay()">‚úÖ Crear D√≠a OT FILE</button>
        </div>
        <div id="ot-panel-list" class="panel-content"><div id="otDaysList" style="max-height:350px;overflow-y:auto;"><div style="text-align:center;color:#999;padding:30px;">No hay d√≠as OT FILE creados</div></div></div>
        <div id="ot-panel-assign" class="panel-content">
            <div style="margin-bottom:15px;"><label style="display:block;margin-bottom:5px;font-weight:600;">üìÖ Selecciona d√≠a OT:</label><select id="otSelectDay" onchange="loadOtDayForAssignment()" style="padding:10px;border:2px solid #ddd;border-radius:8px;font-size:1rem;width:100%;max-width:350px;"><option value="">-- Selecciona --</option></select></div>
            <div id="otAssignmentPanel" style="display:none;">
                <div class="ot-info-box"><h4 id="assignOtName"></h4><p><strong>Apuntados:</strong> <span id="assignOtCount"></span></p></div>
                <div class="modal-section-title">üë• Solicitudes</div><div class="ot-requests-list" id="otAssignRequestsList"></div>
                <div class="modal-section-title">üìã Asignaci√≥n</div>
                <div class="ot-assignment-grid">
                    <div class="ot-assignment-column"><div class="column-header morning">‚òÄÔ∏è MA√ëANA</div><div id="assignListMorning" class="employee-list"></div></div>
                    <div class="ot-assignment-column"><div class="column-header afternoon">üåÖ TARDE</div><div id="assignListAfternoon" class="employee-list"></div></div>
                    <div class="ot-assignment-column"><div class="column-header night">üåô NOCHE</div><div id="assignListNight" class="employee-list"></div></div>
                </div>
                <div style="margin-top:15px;"><button class="btn btn-save" onclick="saveOtAssignments()">üíæ Guardar Asignaciones</button></div>
            </div>
        </div>
        <div style="margin-top:20px;border-top:1px solid #eee;padding-top:15px;"><button class="modal-close" onclick="closeOtManagerModal()">Cerrar</button></div>
    </div>
</div>

<div class="modal-overlay" id="userSettingsModal">
    <div class="modal">
        <h3>‚öôÔ∏è Mi Cuenta</h3>
        <div class="manager-info"><h4>üë§ <span id="settingsUserName"></span></h4><p>Login: <strong id="settingsUserLogin"></strong></p><p>Crew: <strong id="settingsUserCrew"></strong></p><span class="manager-role-badge" id="settingsUserRole"></span></div>
        <div class="password-section"><h4>üîë Cambiar contrase√±a</h4><input type="password" id="userNewPassword1" placeholder="Nueva contrase√±a..." style="max-width:250px;"><input type="password" id="userNewPassword2" placeholder="Repetir contrase√±a..." style="max-width:250px;"><button class="btn btn-save" onclick="changeUserPassword()" style="margin-top:10px;">üíæ Guardar</button></div>
        <div style="margin-top:20px;"><button class="modal-close" onclick="closeUserSettingsModal()">Cerrar</button></div>
    </div>
</div>

<div class="modal-overlay" id="managerModal">
    <div class="modal modal-large">
        <h3>üëë Panel Manager</h3>
        <div class="manager-info">
            <h4>üë§ <span id="currentManagerName"></span></h4>
            <p>Login: <strong id="currentManagerLogin"></strong></p>
            <span class="manager-role-badge" id="currentManagerRole"></span>
        </div>
        <div class="panel-nav">
            <button class="panel-nav-btn active" onclick="switchPanel('import',this)">üì• Importar</button>
            <button class="panel-nav-btn" onclick="switchPanel('passwords',this)">üîë Contrase√±as</button>
            <button class="panel-nav-btn" onclick="switchPanel('vacaciones',this)">üèñÔ∏è Vacaciones</button>
            <button class="panel-nav-btn" onclick="switchPanel('herramientas',this)">üõ†Ô∏è Herramientas</button>
        </div>
        <div id="panel-import" class="panel-content active">
            <div class="import-info"><strong>üìå Instrucciones:</strong><br>1. Copia los datos TSV desde Excel<br>2. P√©galos aqu√≠<br>3. Clic en Importar<br><br><strong style="color:#e74c3c;">‚ö†Ô∏è IMPORTANTE: Al importar se limpiar√°n las solicitudes antiguas y el historial para liberar espacio en la base de datos.</strong></div>
            <div class="import-panel">
                <textarea id="bulkImportData" placeholder="Pega aqu√≠ los datos TSV..."></textarea>
                <div class="btn-row">
                    <button class="btn btn-save" onclick="processBulkImportClean()">‚úÖ Importar y Limpiar BD</button>
                    <button class="btn btn-export" onclick="previewBulkImport()">üëÅÔ∏è Vista Previa</button>
                    <button class="btn btn-danger" onclick="cleanDatabaseManual()">üóëÔ∏è Solo Limpiar BD</button>
                </div>
            </div>
            <div id="importPreview" style="margin-top:10px;text-align:left;font-size:0.8rem;max-height:150px;overflow-y:auto;"></div>
            <div id="dbSizeInfo" style="margin-top:15px;background:#f8f9fa;padding:12px;border-radius:8px;">
                <h4 style="margin-bottom:8px;font-size:0.85rem;">üìä Estado de la Base de Datos</h4>
                <div id="dbSizeDetails" style="font-size:0.8rem;color:#666;"></div>
            </div>
        </div>
        <div id="panel-passwords" class="panel-content">
            <h4 style="margin-bottom:10px;">üîë Gesti√≥n de Contrase√±as</h4>
            <div class="import-info"><strong>üìå Informaci√≥n:</strong><br>‚Ä¢ La contrase√±a por defecto es <strong>1234</strong><br>‚Ä¢ Al resetear, la contrase√±a volver√° a <strong>1234</strong></div>
            <div style="margin:15px 0;">
                <label style="display:block;margin-bottom:5px;font-weight:600;">üë§ Selecciona usuario:</label>
                <input type="text" id="passwordUserSearch" placeholder="üîç Buscar por nombre..." oninput="filterPasswordUsers()" style="padding:8px 12px;border:2px solid #ddd;border-radius:8px;width:100%;max-width:300px;margin-bottom:8px;">
                <select id="passwordUserSelect" onchange="showPasswordUserInfo(this.value)" style="padding:10px;border:2px solid #ddd;border-radius:8px;font-size:1rem;width:100%;max-width:350px;"><option value="">-- Selecciona un usuario --</option></select>
            </div>
            <div id="passwordUserInfo" style="display:none;background:#f8f9fa;padding:15px;border-radius:12px;margin:15px 0;">
                <h4 style="margin-bottom:8px;">üë§ <span id="pwUserName"></span></h4>
                <p style="font-size:0.85rem;color:#666;">Login: <strong id="pwUserLogin"></strong></p>
                <p style="font-size:0.85rem;color:#666;">Crew: <strong id="pwUserCrew"></strong></p>
                <p style="font-size:0.85rem;color:#666;">Rol: <strong id="pwUserRole"></strong></p>
                <p style="font-size:0.85rem;margin-top:8px;">Estado contrase√±a: <span id="pwStatus" class="password-status"></span></p>
                <div style="margin-top:15px;display:flex;gap:10px;flex-wrap:wrap;">
                    <button class="btn btn-warning" onclick="resetUserPassword()">üîÑ Resetear a 1234</button>
                    <button class="btn btn-save" onclick="setCustomPassword()">üîê Poner contrase√±a</button>
                </div>
            </div>
            <div id="passwordSummary" style="background:#f8f9fa;padding:15px;border-radius:12px;margin-top:15px;"></div>
        </div>
        <div id="panel-vacaciones" class="panel-content">
            <h4 style="margin-bottom:15px;">üèñÔ∏è Gesti√≥n de Vacaciones y Asuntos Propios</h4>
            <div style="margin:15px 0;"><input type="text" id="vacPanelSearch" placeholder="üîç Buscar empleado..." oninput="filterVacacionesPanel()" style="padding:10px;border:2px solid #ddd;border-radius:8px;width:100%;max-width:300px;"></div>
            <div class="vac-general-container" style="max-height:350px;">
                <table class="vac-general-table" id="vacPanelTable">
                    <thead><tr><th>Empleado</th><th>Crew</th><th style="background:#9c27b0;">Pend.</th><th style="background:#9c27b0;">Rest.</th><th style="background:#2196f3;">Asig.</th><th style="background:#2196f3;">Rest.</th><th style="background:#ff9800;">AP</th><th>Acciones</th></tr></thead>
                    <tbody id="vacPanelBody"></tbody>
                </table>
            </div>
        </div>
        <div id="panel-herramientas" class="panel-content">
            <h4 style="margin-bottom:15px;">üõ†Ô∏è Herramientas</h4>
            <div class="tools-grid">
                <div class="tool-card"><div class="tool-icon">üì§</div><h5>Exportar JSON</h5><p>Copia de seguridad de todos los datos.</p><button class="btn btn-export" onclick="exportData()">üì§ Exportar</button></div>
                <div class="tool-card"><div class="tool-icon">üìä</div><h5>Exportar a Excel</h5><p>Exporta los turnos en formato TSV.</p><button class="btn btn-save" onclick="exportToTSV()">üìä Exportar TSV</button></div>
                <div class="tool-card"><div class="tool-icon">üîß</div><h5>D√≠as OT FILE</h5><p>Crear y gestionar d√≠as de OT FILE.</p><button class="btn btn-ot" onclick="closeManagerModal();openOtManagerModal();">üîß Gestionar OT</button></div>
                <div class="tool-card"><div class="tool-icon">üóëÔ∏è</div><h5>Limpiar BD</h5><p>Elimina solicitudes e historial para liberar espacio.</p><button class="btn btn-danger" onclick="cleanDatabaseManual()">üóëÔ∏è Limpiar</button></div>
            </div>
            <div class="modal-section-title" style="margin-top:20px;">üìä Estad√≠sticas Generales</div>
            <div id="generalStats" class="general-stats-grid"></div>
        </div>
        <div style="margin-top:20px;border-top:1px solid #eee;padding-top:15px;"><button class="modal-close" onclick="closeManagerModal()">Cerrar</button></div>
    </div>
</div>

<div class="modal-overlay" id="customPasswordModal">
    <div class="modal">
        <h3>üîê Establecer Contrase√±a</h3>
        <div id="customPwUserInfo" style="background:#f0f4f8;padding:12px;border-radius:8px;margin-bottom:15px;"><strong id="customPwUserName"></strong></div>
        <input type="password" id="customNewPassword1" placeholder="Nueva contrase√±a..." style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;margin-bottom:10px;max-width:300px;">
        <input type="password" id="customNewPassword2" placeholder="Repetir contrase√±a..." style="width:100%;padding:12px;border:2px solid #ddd;border-radius:8px;margin-bottom:15px;max-width:300px;">
        <div style="display:flex;gap:10px;justify-content:center;">
            <button class="btn btn-save" onclick="confirmCustomPassword()">‚úÖ Guardar</button>
            <button class="modal-close" onclick="closeCustomPasswordModal()">Cancelar</button>
        </div>
    </div>
</div>

<div class="modal-overlay" id="editVacacionesModal">
    <div class="modal modal-large">
        <h3>üèñÔ∏è Editar Vacaciones y AP</h3>
        <div class="manager-info" style="background:linear-gradient(135deg,#4caf50,#2e7d32);">
            <h4>üë§ <span id="vacEditEmployeeName"></span></h4>
            <p>Login: <strong id="vacEditEmployeeLogin"></strong></p>
        </div>
        <div class="vac-edit-grid">
            <div class="vac-edit-group anterior"><label>üìÖ Vac. Pendientes A√±o Anterior</label><input type="number" id="vacEditPendientesAnt" step="0.5" min="0"></div>
            <div class="vac-edit-group anterior"><label>üìÖ Vac. Restantes A√±o Anterior</label><input type="number" id="vacEditRestantesAnt" step="0.5" min="0"></div>
            <div class="vac-edit-group anterior"><label>üìÖ Vac. Consumidas del A√±o Anterior</label><input type="number" id="vacEditConsumidasAnt" step="0.5" min="0"></div>
            <div class="vac-edit-group actual"><label>üóìÔ∏è Vac. Asignadas 2026</label><input type="number" id="vacEditAsignadas2026" step="0.5" min="0"></div>
            <div class="vac-edit-group actual"><label>üóìÔ∏è Vac. Restantes 2026</label><input type="number" id="vacEditRestantes2026" step="0.5" min="0"></div>
            <div class="vac-edit-group actual"><label>üóìÔ∏è Vac. Consumidas 2026</label><input type="number" id="vacEditConsumidas2026" step="0.5" min="0"></div>
            <div class="vac-edit-group ap" style="grid-column:span 2;"><label>üìã Asuntos Propios Consumidos</label><input type="number" id="vacEditApConsumidos" step="0.5" min="0"></div>
        </div>
        <div style="margin-top:20px;display:flex;gap:10px;justify-content:center;">
            <button class="btn btn-save" onclick="saveVacacionesEdit()">üíæ Guardar</button>
            <button class="modal-close" onclick="closeVacacionesModal()">Cancelar</button>
        </div>
    </div>
</div>

<!-- ATTENDANCE SHEET v2 -->
<div class="att-overlay" id="attOverlay">
    <div class="att-container">
        <div class="att-topbar">
            <div class="att-topbar-left">
                <h2>üìã Attendance Sheet ‚Äî Formaci√≥n Semanal 2026</h2>
                <p id="attWeekLabel">Selecciona una semana para generar el documento</p>
            </div>
            <div class="att-topbar-right">
                <select class="att-week-select" id="attWeekSel" onchange="buildAttendance()">
                    <option value="">‚Äî Selecciona semana ‚Äî</option>
                </select>
                <button class="att-btn att-btn-print" onclick="printAttendance()">üñ®Ô∏è Imprimir</button>
                <button class="att-btn att-btn-close" onclick="closeAttendance()">‚úï Cerrar</button>
            </div>
        </div>
        <div class="att-body" id="attBody">
            <p style="text-align:center;color:#aaa;padding:40px;font-size:0.9rem;">
                Selecciona una semana para generar el attendance sheet.
            </p>
        </div>
    </div>
</div>

<div class="notification" id="notification"></div>

<script>
// =====================================================
// CONFIGURACI√ìN
// =====================================================
const JSONBIN_BIN_ID = '693ed2a043b1c97be9edc0a2';
const JSONBIN_API_KEY = '$2a$10$dTBuSlF/Shyoqcoyhbid5OWMYIAkeEYHS4HiiXpgarzEJJQaj5A.O';
const JSONBIN_URL = `https://api.jsonbin.io/v3/b/${JSONBIN_BIN_ID}`;
const MANAGER_ROLES = ['RMEAN','RMEAM','IRMEAM','RMEM','GEM'];
const DEFAULT_PASSWORD = '1234';
const MIN_SRME_PER_SHIFT = 2;
const MIN_RMET_PER_SHIFT = 3;
const RMET_ROLES = ['RMET','APP4','RMEO','APP3','APP5','APP6-OK','APP6'];
const SHIFT_SCHEDULES = {
    'wm': {hours:'06:00 - 15:10',desc:'Ma√±ana Larga', type:'morning'},
    'm8': {hours:'06:00 - 14:10',desc:'Ma√±ana 8h', type:'morning'},
    'm': {hours:'08:00 - 13:00',desc:'Ma√±ana', type:'morning'},
    'm-co': {hours:'08:00 - 13:00',desc:'Ma√±ana Reducida', type:'morning'},
    'wt': {hours:'14:00 - 23:10',desc:'Tarde Larga', type:'afternoon'},
    't8': {hours:'14:00 - 22:10',desc:'Tarde 8h', type:'afternoon'},
    't': {hours:'13:00 - 18:00',desc:'Tarde', type:'afternoon'},
    't-co': {hours:'13:00 - 18:00',desc:'Tarde Reducida', type:'afternoon'},
    'n8': {hours:'22:00 - 06:10',desc:'Noche 8h', type:'night'},
    'n': {hours:'22:00 - 06:30',desc:'Noche', type:'night'},
    'nn': {hours:'00:00 - 06:30',desc:'Noche Corta', type:'night'},
    'n-co': {hours:'23:00 - 04:00',desc:'Noche Reducida', type:'night'},
    'wn': {hours:'22:00 - 06:30',desc:'Noche Larga', type:'night'},
    'c': {hours:'09:00 - 18:00',desc:'Central', type:'central'},
    'cw': {hours:'09:00 - 18:00',desc:'Central', type:'central'},
    'wc': {hours:'09:00 - 18:00',desc:'Central Larga', type:'central'},
    'c8': {hours:'09:00 - 17:00',desc:'Central 8h', type:'central'},
    'v': {hours:'-',desc:'Vacaciones', type:'vacation'},
    'v25': {hours:'-',desc:'Vacaciones 2025',type:'vacation'},
    'v26': {hours:'-',desc:'Vacaciones 2026',type:'vacation'},
    'ap': {hours:'-',desc:'Asuntos Propios',type:'personal'},
    'tr': {hours:'-',desc:'Formaci√≥n', type:'training'},
    'bm': {hours:'-',desc:'Baja M√©dica', type:'leave'},
    'bp': {hours:'-',desc:'Baja Paternidad',type:'leave'}
};
const festivos2026 = [
    {month:1,day:1,name:"A√±o Nuevo"},{month:1,day:6,name:"Reyes"},
    {month:2,day:28,name:"D√≠a de Andaluc√≠a"},{month:4,day:2,name:"Jueves Santo"},
    {month:4,day:3,name:"Viernes Santo"},{month:5,day:1,name:"D√≠a del Trabajo"},
    {month:5,day:7,name:"Feria Dos Hermanas"},{month:8,day:15,name:"Asunci√≥n"},
    {month:10,day:12,name:"Fiesta Nacional"},{month:10,day:19,name:"Fiesta Local"},
    {month:11,day:2,name:"Todos los Santos"},{month:12,day:7,name:"Constituci√≥n"},
    {month:12,day:8,name:"Inmaculada"},{month:12,day:25,name:"Navidad"}
];
const monthNames = ['ENERO','FEBRERO','MARZO','ABRIL','MAYO','JUNIO','JULIO','AGOSTO','SEPTIEMBRE','OCTUBRE','NOVIEMBRE','DICIEMBRE'];
const daysInMonth = [31,28,31,30,31,30,31,31,30,31,30,31];
const startDays = [3,6,6,2,4,0,2,5,1,3,6,1];

let allData = {empleados:[],festivos:festivos2026,userPasswords:{},otDays:[]};
let selectedEmployee = null;
let currentUser = null;
let isManager = false;
let editingDay = null;
let isGeneralView = false;
let isMyCalendarView = true;
let currentOtDay = null;
let newOtDays = [];
let selectedPasswordUser = null;
let editingVacacionesEmployee = null;

    
    function isCentralShift(shift) {
    if (!shift) return false;
    const s = shift.toLowerCase().trim();
    // Cualquier combinaci√≥n: c, cw, wc, c8, c10, etc.
    // Excluye los que no son central (como 'co' suelto si existiera)
    if (s === 'c' || s === 'cw' || s === 'wc' || s === 'c8') return true;
    // Gen√©rico: empieza por 'c' seguido de n√∫mero = central
    if (/^c\d/.test(s)) return true;
    // Empieza por 'wc' = central larga
    if (s.startsWith('wc')) return true;
    return false;
}

// =====================================================
// UTILIDAD
// =====================================================
function getShiftInfo(shift){ if(!shift)return{hours:'-',desc:'Libre',type:'free'}; return SHIFT_SCHEDULES[shift.toLowerCase()]||{hours:'-',desc:shift.toUpperCase(),type:'unknown'}; }
function classifyRole(role){
    if(!role)return'otros'; const r=role.toUpperCase().trim();
    if(r.includes('SRME')||r.includes('SR ME')||r.includes('SR-ME'))return'srme';
    for(const rmet of RMET_ROLES){if(r.includes(rmet)||r===rmet)return'rmet';}
    return'otros';
}
function isManagerRole(role){ if(!role)return false; const r=role.toUpperCase().trim(); return MANAGER_ROLES.some(mr=>r.includes(mr)||r===mr); }
function getAbsenceLabel(shift){ const s=shift.toLowerCase(); if(['v','v25','v26'].includes(s))return'Vacaciones'; if(s.startsWith('ap'))return'Asuntos Propios'; if(s==='tr')return'Formaci√≥n'; if(s==='bm')return'Baja M√©dica'; if(s==='bp')return'Baja Paternidad'; return'Ausencia'; }
function turnosStringToArray(turnosData){ if(Array.isArray(turnosData)){const arr=turnosData.map(t=>(t||'').toString().trim()); while(arr.length<365)arr.push(''); return arr.slice(0,365);} if(!turnosData||typeof turnosData!=='string')return new Array(365).fill(''); const arr=turnosData.split(',').map(t=>t.trim()); while(arr.length<365)arr.push(''); return arr.slice(0,365); }
function turnosArrayToString(turnosArray){ if(!turnosArray)return new Array(365).fill('').join(','); if(!Array.isArray(turnosArray))return turnosArray.toString(); return turnosArray.join(','); }
function normalizarEmpleados(empleados){ return empleados.map(emp=>({crew:emp.crew||'',login:emp.login||'',name:emp.name||'',role:emp.role||'',turnos:turnosStringToArray(emp.turnos),vacPendientesAnt:parseFloat(emp.vacPendientesAnt)||0,vacRestantesAnt:parseFloat(emp.vacRestantesAnt)||0,vacConsumidasAnt:parseFloat(emp.vacConsumidasAnt)||0,vacAsignadas2026:parseFloat(emp.vacAsignadas2026)||0,vacRestantes2026:parseFloat(emp.vacRestantes2026)||0,vacConsumidas2026:parseFloat(emp.vacConsumidas2026)||0,apConsumidos:parseFloat(emp.apConsumidos)||0})); }
function isFestivo(m,d){return festivos2026.some(f=>f.month===m&&f.day===d);}
function getFestivoName(m,d){const f=festivos2026.find(f=>f.month===m&&f.day===d);return f?f.name:'';}
function getDayOfYear(m,d){let doy=0;for(let i=0;i<m-1;i++)doy+=daysInMonth[i];return doy+d-1;}
function isReducido(shift){return shift&&shift.toLowerCase().includes('-co');}
function getOtDay(doy){return allData.otDays?allData.otDays.find(ot=>ot.doy===doy):null;}
function isOtFileDay(month,day){return allData.otDays&&allData.otDays.some(ot=>ot.doy===getDayOfYear(month,day));}
function getDayString(doy){let r=doy;for(let m=0;m<12;m++){if(r<daysInMonth[m])return`${r+1} de ${monthNames[m]}`;r-=daysInMonth[m];}return'D√≠a '+(doy+1);}
function getDayFromDoy(doy){let r=doy;for(let m=0;m<12;m++){if(r<daysInMonth[m])return{month:m+1,day:r+1};r-=daysInMonth[m];}return{month:12,day:31};}
function setDataStatus(type,message){const el=document.getElementById('dataStatus');if(el){el.textContent=message;el.className='data-status '+type;}}
function showNotification(msg,isError=false){const n=document.getElementById('notification');n.textContent=msg;n.className='notification'+(isError?' error':'');n.classList.add('show');setTimeout(()=>n.classList.remove('show'),2500);}
function formatVacNumber(num){if(num===null||num===undefined||isNaN(num))return'0';const n=parseFloat(num);return n%1===0?n.toString():n.toFixed(1);}

// =====================================================
// LOCAL STORAGE
// =====================================================
function getSeenOtDays(login){try{const s=localStorage.getItem('seenOtDays_'+login);return s?JSON.parse(s):[];}catch(e){return[];}}
function addSeenOtDays(login,otDoys){try{const c=getSeenOtDays(login);localStorage.setItem('seenOtDays_'+login,JSON.stringify([...new Set([...c,...otDoys])]));}catch(e){}}

// =====================================================
// ALERTAS
// =====================================================
function detectNewOtDays(login){if(!allData.otDays||allData.otDays.length===0)return[];const seen=getSeenOtDays(login);return allData.otDays.filter(ot=>!seen.includes(ot.doy));}
function showAlertsIfNeeded(){
    if(!currentUser)return;
    newOtDays=detectNewOtDays(currentUser.login);
    const ac=document.getElementById('alertsContainer');
    const ob=document.getElementById('newOtAlertBox');
    if(newOtDays.length>0){
        ob.classList.remove('hidden');
        document.getElementById('newOtAlertList').innerHTML=newOtDays.map(ot=>`<div class="ot-item" onclick="openOtFileModal(${ot.month},${ot.day})"><div class="ot-date">üìÖ ${ot.day} de ${monthNames[ot.month-1]}</div><div class="ot-name">${ot.name}</div></div>`).join('');
        ac.classList.remove('hidden');
    } else { ob.classList.add('hidden'); ac.classList.add('hidden'); }
}
function dismissOtAlert(){if(currentUser&&newOtDays.length>0)addSeenOtDays(currentUser.login,newOtDays.map(ot=>ot.doy));document.getElementById('newOtAlertBox').classList.add('hidden');document.getElementById('alertsContainer').classList.add('hidden');}

// =====================================================
// JSONBIN
// =====================================================
async function saveToCloud(){
    try{
        setDataStatus('loading','‚è≥ Guardando...');
        const emp=allData.empleados.map(e=>({crew:e.crew||'',login:e.login||'',name:e.name||'',role:e.role||'',turnos:Array.isArray(e.turnos)?turnosArrayToString(e.turnos):(e.turnos||''),vacPendientesAnt:e.vacPendientesAnt||0,vacRestantesAnt:e.vacRestantesAnt||0,vacConsumidasAnt:e.vacConsumidasAnt||0,vacAsignadas2026:e.vacAsignadas2026||0,vacRestantes2026:e.vacRestantes2026||0,vacConsumidas2026:e.vacConsumidas2026||0,apConsumidos:e.apConsumidos||0}));
        const data={empleados:emp,userPasswords:allData.userPasswords||{},otDays:(allData.otDays||[]).map(ot=>({doy:ot.doy,month:ot.month,day:ot.day,name:ot.name,notes:ot.notes||'',createdBy:ot.createdBy,createdByName:ot.createdByName,createdAt:ot.createdAt,status:ot.status,signups:(ot.signups||[]).map(s=>({login:s.login,name:s.name,role:s.role,crew:s.crew,preferences:s.preferences,comment:s.comment||'',timestamp:s.timestamp})),assignments:ot.assignments||{morning:[],afternoon:[],night:[]}})),lastModified:new Date().toISOString(),version:'3.0-lite'};
        const r=await fetch(JSONBIN_URL,{method:'PUT',headers:{'Content-Type':'application/json','X-Master-Key':JSONBIN_API_KEY},body:JSON.stringify(data)});
        if(!r.ok)throw new Error('Error al guardar');
        setDataStatus('online','‚òÅÔ∏è Sincronizado: '+new Date().toLocaleTimeString());
        return true;
    }catch(e){console.error(e);setDataStatus('offline','‚ùå Error al guardar');showNotification('‚ùå Error al guardar',true);return false;}
}

async function loadFromCloud(){
    try{
        setDataStatus('loading','‚è≥ Cargando...');
        const r=await fetch(JSONBIN_URL+'/latest',{headers:{'X-Master-Key':JSONBIN_API_KEY}});
        if(!r.ok)throw new Error('Error al cargar');
        const data=await r.json();
        if(data.record&&data.record.empleados&&data.record.empleados.length>0){
            const emp=normalizarEmpleados(data.record.empleados);
            setDataStatus('online','‚òÅÔ∏è '+emp.length+' empleados');
            return{empleados:emp,userPasswords:data.record.userPasswords||{},otDays:data.record.otDays||[],festivos:festivos2026};
        }
        setDataStatus('online','‚òÅÔ∏è Sin datos');
        return{empleados:[],userPasswords:{},otDays:[],festivos:festivos2026};
    }catch(e){console.error(e);setDataStatus('offline','‚ùå Error conexi√≥n');return null;}
}

// =====================================================
// DB SIZE
// =====================================================
function estimateDBSize(){
    try{
        const es=JSON.stringify(allData.empleados.map(e=>({...e,turnos:turnosArrayToString(e.turnos)})));
        const ps=JSON.stringify(allData.userPasswords||{});
        const os=JSON.stringify(allData.otDays||[]);
        const total=((es.length+ps.length+os.length+200)/1024).toFixed(1);
        const pct=Math.min(100,(total/100*100)).toFixed(0);
        return{empleados:(es.length/1024).toFixed(1),passwords:(ps.length/1024).toFixed(1),otDays:(os.length/1024).toFixed(1),total,pct};
    }catch(e){return{total:'?',pct:'?'};}
}
function updateDBSizeInfo(){
    const info=estimateDBSize();
    const el=document.getElementById('dbSizeDetails');
    if(!el)return;
    const color=info.pct>80?'#e74c3c':info.pct>60?'#f39c12':'#27ae60';
    el.innerHTML=`<div style="margin-bottom:8px;"><div style="background:#eee;border-radius:10px;height:20px;overflow:hidden;"><div style="background:${color};height:100%;width:${info.pct}%;border-radius:10px;"></div></div><span style="font-size:0.75rem;color:${color};font-weight:600;">${info.pct}% usado</span></div><div>üìä Empleados: <strong>${info.empleados} KB</strong></div><div>üîë Contrase√±as: <strong>${info.passwords} KB</strong></div><div>üîß OT Days: <strong>${info.otDays} KB</strong></div><div style="border-top:1px solid #ddd;padding-top:5px;margin-top:5px;">üì¶ <strong>Total: ${info.total} KB</strong></div>`;
}

// =====================================================
// PARSEO TSV
// =====================================================
function parseRawData(rawData){
    const lines=rawData.trim().split('\n');
    const empleados=[];
    lines.forEach(line=>{
        const parts=line.split('\t');
        if(parts.length<15)return;
        const crew=parts[0].trim(),login=parts[1].trim(),name=parts[2].trim();
        if(!login||login==='0'||!name)return;
        let role='',di=3;
        if(parts[3].trim()!==''&&isNaN(parseFloat(parts[3].replace(',','.')))) {role=parts[3].trim();di=4;}
        else if(parts[4]&&parts[4].trim()!==''&&isNaN(parseFloat(parts[4].replace(',','.')))) {role=parts[4].trim();di=5;}
        const vpa=parseFloat(String(parts[di]||'0').replace(',','.'))||0;
        const vra=parseFloat(String(parts[di+1]||'0').replace(',','.'))||0;
        const vca=parseFloat(String(parts[di+2]||'0').replace(',','.'))||0;
        const va26=parseFloat(String(parts[di+3]||'0').replace(',','.'))||0;
        const vr26=parseFloat(String(parts[di+4]||'0').replace(',','.'))||0;
        const vc26=parseFloat(String(parts[di+5]||'0').replace(',','.'))||0;
        const apc=parseFloat(String(parts[di+6]||'0').replace(',','.'))||0;
        const ti=di+7;
        const turnos=[];
        for(let i=ti;i<parts.length&&turnos.length<365;i++)turnos.push((parts[i]||'').trim().toLowerCase());
        while(turnos.length<365)turnos.push('');
        empleados.push({crew,login,name,role,turnos:turnos.slice(0,365),vacPendientesAnt:vpa,vacRestantesAnt:vra,vacConsumidasAnt:vca,vacAsignadas2026:va26,vacRestantes2026:vr26,vacConsumidas2026:vc26,apConsumidos:apc});
    });
    return empleados;
}

// =====================================================
// LOGIN
// =====================================================
async function initializeLogin(){
    document.getElementById('loginLoading').classList.remove('hidden');
    document.getElementById('loginForm').classList.add('hidden');
    const data=await loadFromCloud();
    document.getElementById('loginLoading').classList.add('hidden');
    document.getElementById('loginForm').classList.remove('hidden');
    if(data===null){
        const s=document.getElementById('loginStatus');
        s.textContent='‚ùå Error de conexi√≥n. Intenta de nuevo.';s.className='login-status error';s.classList.remove('hidden');return;
    }
    allData=data;
    if(allData.empleados.length===0){
        const s=document.getElementById('loginStatus');
        s.textContent='‚ö†Ô∏è No hay empleados. Contacta al administrador.';s.className='login-status error';s.classList.remove('hidden');return;
    }
}

function attemptLogin(){
    const login=document.getElementById('loginInput').value.trim();
    const pass=document.getElementById('loginPassword').value;
    const st=document.getElementById('loginStatus');
    if(!login){st.textContent='‚ùå Introduce tu login';st.className='login-status error';st.classList.remove('hidden');return;}
    if(!pass){st.textContent='‚ùå Introduce tu contrase√±a';st.className='login-status error';st.classList.remove('hidden');return;}
    const user=allData.empleados.find(e=>e.login.toLowerCase()===login.toLowerCase());
    if(!user){st.textContent='‚ùå Login no encontrado';st.className='login-status error';st.classList.remove('hidden');return;}
    const stored=allData.userPasswords[user.login]||DEFAULT_PASSWORD;
    if(pass===stored){
        currentUser={login:user.login,name:user.name,role:user.role,crew:user.crew};
        isManager=isManagerRole(user.role);
        st.textContent='‚úÖ Acceso correcto. Cargando...';st.className='login-status success';st.classList.remove('hidden');
        setTimeout(()=>showMainApp(),500);
    } else {
        st.textContent='‚ùå Contrase√±a incorrecta';st.className='login-status error';st.classList.remove('hidden');
    }
}

function showMainApp(){
    document.getElementById('loginScreen').classList.add('hidden');
    document.getElementById('mainApp').classList.remove('hidden');
    document.getElementById('loggedUserName').textContent=currentUser.name;
    document.getElementById('loggedUserRole').textContent=currentUser.role||'Sin rol';
    document.getElementById('loggedUserCrew').textContent='Crew: '+(currentUser.crew||'N/A');
    if(isManager){
        document.getElementById('managerBadge').classList.remove('hidden');
        document.getElementById('btnManagerPanel').classList.remove('hidden');
        document.getElementById('filtersPanel').classList.remove('hidden');
    }
    initializeFilters();showAlertsIfNeeded();showMyCalendar();
    showNotification('üëã Bienvenido '+currentUser.name.split(' ')[0]);
}

function logout(){
    currentUser=null;isManager=false;selectedEmployee=null;
    isGeneralView=false;isMyCalendarView=true;newOtDays=[];
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('loginInput').value='';
    document.getElementById('loginPassword').value='';
    document.getElementById('loginStatus').classList.add('hidden');
    document.getElementById('managerBadge').classList.add('hidden');
    document.getElementById('btnManagerPanel').classList.add('hidden');
    document.getElementById('alertsContainer').classList.add('hidden');
    document.getElementById('filtersPanel').classList.add('hidden');
    const vs=document.getElementById('vacacionesSection');if(vs)vs.remove();
    showNotification('üëã Sesi√≥n cerrada');
}

// =====================================================
// FILTROS
// =====================================================
function initializeFilters(){
    if(!allData.empleados.length)return;
    filterAndUpdateEmployeeList();
    document.getElementById('employeeCount').textContent=`üìä ${allData.empleados.length} empleados`;
}

function filterAndUpdateEmployeeList(){
    if(!allData.empleados.length)return;
    const st=document.getElementById('searchEmployee')?.value.toLowerCase().trim()||'';
    const sel=document.getElementById('filterEmployee');
    const cnt=document.getElementById('filterResultsCount');
    let f=[...allData.empleados];
    if(st)f=f.filter(e=>e.name.toLowerCase().includes(st)||e.login.toLowerCase().includes(st)||e.crew.toLowerCase().includes(st));
    f.sort((a,b)=>a.name.localeCompare(b.name));
    sel.innerHTML='<option value="">-- Vista General --</option>';
    f.forEach(e=>{const mi=isManagerRole(e.role)?' üëë':'';const ct=e.crew?`(${e.crew})`:'';sel.innerHTML+=`<option value="${e.login}">${e.name}${ct}${mi}</option>`;});
    if(cnt)cnt.textContent=st?`${f.length} de ${allData.empleados.length}`:`${allData.empleados.length} empleados`;
}

function selectEmployee(){
    if(!isManager)return;
    const login=document.getElementById('filterEmployee').value;
    if(!login){showGeneralView();return;}
    selectedEmployee=allData.empleados.find(e=>e.login===login);
    if(!selectedEmployee)return;
    isGeneralView=false;isMyCalendarView=false;
    document.getElementById('btnGeneral').classList.remove('active');
    document.getElementById('btnMyCalendar').classList.remove('active');
    document.getElementById('generalViewInfo').style.display='none';
    document.getElementById('employeeName').textContent=selectedEmployee.name;
    document.getElementById('employeeCrew').textContent=selectedEmployee.crew;
    document.getElementById('employeeRole').textContent=selectedEmployee.role;
    document.getElementById('employeeLogin').textContent=selectedEmployee.login;
    document.getElementById('employeeInfo').classList.add('active');
    generateCalendar();generateStats();updateVacacionesDisplay();
    document.getElementById('statsContainer').style.display='block';
}

async function reloadFromCloud(){
    showNotification('üîÑ Recargando...');
    const data=await loadFromCloud();
    if(data){
        allData=data;initializeFilters();showAlertsIfNeeded();
        if(isMyCalendarView)showMyCalendar();
        else if(isGeneralView)showGeneralView();
        else if(selectedEmployee){
            selectedEmployee=allData.empleados.find(e=>e.login===selectedEmployee.login);
            if(selectedEmployee){generateCalendar();generateStats();updateVacacionesDisplay();}else showMyCalendar();
        }
        showNotification('‚úÖ Datos actualizados');
    }
}

// =====================================================
// MI CALENDARIO / VISTA GENERAL
// =====================================================
function showMyCalendar(){
    if(!currentUser)return;
    isMyCalendarView=true;isGeneralView=false;
    selectedEmployee=allData.empleados.find(e=>e.login===currentUser.login);
    if(!selectedEmployee){showNotification('‚ùå No se encontr√≥ tu perfil',true);return;}
    if(document.getElementById('filterEmployee'))document.getElementById('filterEmployee').value='';
    document.getElementById('btnMyCalendar').classList.add('active');
    document.getElementById('btnGeneral').classList.remove('active');
    document.getElementById('generalViewInfo').style.display='none';
    document.getElementById('employeeName').textContent=selectedEmployee.name+' (T√∫)';
    document.getElementById('employeeCrew').textContent=selectedEmployee.crew;
    document.getElementById('employeeRole').textContent=selectedEmployee.role;
    document.getElementById('employeeLogin').textContent=selectedEmployee.login;
    document.getElementById('employeeInfo').classList.add('active');
    generateCalendar();generateStats();updateVacacionesDisplay();
    document.getElementById('statsContainer').style.display='block';
}

function showGeneralView(){
    isGeneralView=true;isMyCalendarView=false;selectedEmployee=null;
    if(document.getElementById('filterEmployee'))document.getElementById('filterEmployee').value='';
    document.getElementById('btnGeneral').classList.add('active');
    document.getElementById('btnMyCalendar').classList.remove('active');
    document.getElementById('generalViewInfo').style.display='block';
    document.getElementById('employeeInfo').classList.remove('active');
    document.getElementById('statsContainer').style.display='none';
    const vs=document.getElementById('vacacionesSection');if(vs)vs.remove();
    generateGeneralCalendar();
}

function generateGeneralCalendar(){
    if(!allData.empleados.length){document.getElementById('calendarGrid').innerHTML='<div class="loading">No hay datos</div>';return;}
    let html='';for(let m=1;m<=12;m++)html+=generateGeneralMonth(m);
    document.getElementById('calendarGrid').innerHTML=html;
}

function generateGeneralMonth(month){
    let html=`<div class="month-card"><div class="month-header"><h2>${monthNames[month-1]}</h2></div><table class="calendar-table"><thead><tr><th>L</th><th>M</th><th>X</th><th>J</th><th>V</th><th>S</th><th>D</th></tr></thead><tbody>`;
    let day=1;
    const weeks=Math.ceil((daysInMonth[month-1]+startDays[month-1])/7);
    for(let w=0;w<weeks;w++){
        html+='<tr>';
        for(let d=0;d<7;d++){
            if((w===0&&d<startDays[month-1])||day>daysInMonth[month-1]){html+='<td class="empty"></td>';}
            else{
                const fest=isFestivo(month,day);const isOt=isOtFileDay(month,day);
                const alarmClass=getAlarmClass(month,day);
                let classes=[],onclick=`openDayOverviewModal(${month},${day})`,extra='';
                if(isOt){
                    classes.push('ot-file-day');onclick=`openOtFileModal(${month},${day})`;extra=`<span class="shift-code">OT</span>`;
                    const otDay=getOtDay(getDayOfYear(month,day));
                    if(otDay){if(currentUser&&otDay.signups&&otDay.signups.some(s=>s.login===currentUser.login))classes.push('user-signed');if(currentUser&&otDay.assignments&&['morning','afternoon','night'].some(sh=>otDay.assignments[sh]&&otDay.assignments[sh].some(a=>a.login===currentUser.login)))classes.push('user-assigned');}
                } else if(alarmClass){classes.push(alarmClass);}
                else{classes.push('general-day');if(d===5)classes.push('weekend-sat');if(d===6)classes.push('weekend-sun');}
                if(fest)classes.push('festivo');
                html+=`<td class="${classes.join(' ')}" onclick="${onclick}"><span class="day-num">${day}</span>${extra}</td>`;day++;
            }
        }
        html+='</tr>';
    }
    html+='</tbody></table></div>';return html;
}

// =====================================================
// AN√ÅLISIS PERSONAL
// =====================================================
function analyzeStaffingForDay(month,day){
    const doy=getDayOfYear(month,day);
    const s={morning:{total:0,employees:[],roleCount:{}},afternoon:{total:0,employees:[],roleCount:{}},night:{total:0,employees:[],roleCount:{}},central:{total:0,employees:[],roleCount:{}},absent:{total:0,employees:[],byType:{vac:[],ap:[],tr:[],baja:[]}}};
    const alarms={morning:{lowSrme:false,lowRmet:false},afternoon:{lowSrme:false,lowRmet:false},night:{lowSrme:false,lowRmet:false}};
    allData.empleados.forEach(emp=>{
        const shift=(emp.turnos[doy]||'').toLowerCase();if(!shift)return;
        const si=getShiftInfo(shift);const rt=classifyRole(emp.role);const rd=emp.role||'Sin rol';
        const ed={name:emp.name,crew:emp.crew,login:emp.login,role:rd,roleType:rt,shift:shift.toUpperCase(),hours:si.hours};
        let st=null,at=null;
        if(['wm','m8','m','m-co'].includes(shift))st='morning';
        else if(['wt','t8','t','t-co'].includes(shift))st='afternoon';
        else if(['n8','n','nn','wn','n-co'].includes(shift))st='night';
        else if(isCentralShift(shift))st='central';
        else if(['v','v25','v26'].includes(shift))at='vac';
        else if(shift.startsWith('ap'))at='ap';
        else if(shift==='tr')at='tr';
        else if(['bm','bp'].includes(shift))at='baja';
        if(st){s[st].total++;s[st].employees.push(ed);if(!s[st].roleCount[rd])s[st].roleCount[rd]={count:0,type:rt};s[st].roleCount[rd].count++;}
        else if(at){s.absent.total++;ed.absenceType=at;ed.absenceLabel=getAbsenceLabel(shift);s.absent.employees.push(ed);s.absent.byType[at].push(ed);}
    });
    ['morning','afternoon','night'].forEach(st=>{
        if(s[st].total>0){
            let sc=0,rc=0;Object.entries(s[st].roleCount).forEach(([r,d])=>{if(d.type==='srme')sc+=d.count;else if(d.type==='rmet')rc+=d.count;});
            alarms[st].lowSrme=sc<MIN_SRME_PER_SHIFT;alarms[st].lowRmet=rc<MIN_RMET_PER_SHIFT;s[st].srmeCount=sc;s[st].rmetCount=rc;
        }
    });
    return{staffing:s,alarms};
}

function getAlarmClass(month,day){
    if(isFestivo(month,day)||isOtFileDay(month,day))return'';
    const{alarms,staffing}=analyzeStaffingForDay(month,day);
    const m=(alarms.morning.lowSrme||alarms.morning.lowRmet)&&staffing.morning.total>0;
    const a=(alarms.afternoon.lowSrme||alarms.afternoon.lowRmet)&&staffing.afternoon.total>0;
    const n=(alarms.night.lowSrme||alarms.night.lowRmet)&&staffing.night.total>0;
    if(m&&a&&n)return'alarm-all';if(m&&a)return'alarm-morning-afternoon';if(m&&n)return'alarm-morning-night';if(a&&n)return'alarm-afternoon-night';if(m)return'alarm-morning';if(a)return'alarm-afternoon';if(n)return'alarm-night';return'';
}

// =====================================================
// MODAL VISTA D√çA
// =====================================================
function openDayOverviewModal(month,day){
    if(isOtFileDay(month,day)){openOtFileModal(month,day);return;}
    const{staffing,alarms}=analyzeStaffingForDay(month,day);
    const fest=isFestivo(month,day);
    ['morning','afternoon','night','central','absent'].forEach(s=>staffing[s].employees.sort((a,b)=>a.name.localeCompare(b.name)));
    const dow=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
    const date=new Date(2026,month-1,day);
    document.getElementById('dayOverviewTitle').textContent=`üìÖ ${dow[date.getDay()]} ${day} de ${monthNames[month-1]} 2026`;
    const fb=document.getElementById('dayOverviewFestivo');
    fb.style.display=fest?'inline-block':'none';if(fest)fb.textContent='üéâ '+getFestivoName(month,day);
    document.getElementById('daySummary').innerHTML=generateDaySummary(staffing,alarms,fest);
    ['Morning','Afternoon','Night'].forEach(sn=>{
        const k=sn.toLowerCase();const d=staffing[k];const al=alarms[k];
        document.getElementById('count'+sn).textContent=d.total;
        document.getElementById('roleBreakdown'+sn).innerHTML=generateRoleBreakdown(d,al,!fest);
        document.getElementById('list'+sn).innerHTML=renderEmployeeList(d.employees,k);
        const col=document.getElementById('column'+sn);
        if(!fest&&d.total>0&&(al?.lowSrme||al?.lowRmet))col.classList.add('column-alarm');else col.classList.remove('column-alarm');
    });
    document.getElementById('countCentral').textContent=staffing.central.total;
    document.getElementById('roleBreakdownCentral').innerHTML=generateRoleBreakdown(staffing.central,null,false);
    document.getElementById('listCentral').innerHTML=renderEmployeeList(staffing.central.employees,'central');
    document.getElementById('countAbsent').textContent=staffing.absent.total;
    document.getElementById('roleBreakdownAbsent').innerHTML=generateAbsenceBreakdown(staffing.absent);
    document.getElementById('listAbsent').innerHTML=renderAbsentList(staffing.absent.employees);
    document.getElementById('dayOverviewModal').classList.add('active');
}

function generateDaySummary(staffing,alarms,isFest){
    const shifts=[{key:'morning',name:'Ma√±ana',icon:'‚òÄÔ∏è'},{key:'afternoon',name:'Tarde',icon:'üåÖ'},{key:'night',name:'Noche',icon:'üåô'},{key:'central',name:'Central',icon:'üè¢'},{key:'absent',name:'Ausentes',icon:'üè†'}];
    let html='',total=0;
    shifts.forEach(sh=>{
        const d=staffing[sh.key];const al=alarms[sh.key];const isOp=['morning','afternoon','night'].includes(sh.key);
        const ha=isOp&&!isFest&&d.total>0&&(al?.lowSrme||al?.lowRmet);if(isOp)total+=d.total;
        let bk='';
        if(isOp&&d.total>0)bk=`<span class="summary-breakdown"><span class="srme">${d.srmeCount||0} SRME</span> ¬∑ <span class="rmet">${d.rmetCount||0} RMET</span></span>`;
        else if(sh.key==='absent'&&d.total>0){const bt=d.byType;let pts=[];if(bt.vac.length)pts.push(`${bt.vac.length} Vac`);if(bt.ap.length)pts.push(`${bt.ap.length} AP`);if(bt.tr.length)pts.push(`${bt.tr.length} Form`);if(bt.baja.length)pts.push(`${bt.baja.length} Baja`);bk=`<span class="summary-breakdown">${pts.join(' ¬∑ ')}</span>`;}
        html+=`<div class="summary-item ${ha?'has-alarm':''} ${sh.key==='absent'?'absent-item':''}"><span class="summary-icon">${sh.icon}</span><span class="summary-total">${d.total}</span><span class="summary-label">${sh.name}</span>${bk}</div>`;
    });
    html+=`<div class="summary-item total-item"><span class="summary-icon">üìä</span><span class="summary-total">${total}</span><span class="summary-label">Operativos</span></div>`;
    return html;
}

function generateRoleBreakdown(data,alarm,check){
    if(data.total===0)return'<span style="color:#999;">Sin personal</span>';
    const roles=Object.entries(data.roleCount).sort((a,b)=>b[1].count-a[1].count);
    let html='<div class="role-summary">';
    roles.forEach(([r,info])=>{
        let cc='';if(info.type==='srme')cc='srme';else if(info.type==='rmet')cc='rmet';else if(r.toLowerCase().includes('app'))cc='app';else if(isManagerRole(r))cc='manager';
        let wc='';if(check&&alarm){if(info.type==='srme'&&alarm.lowSrme)wc=' warning';if(info.type==='rmet'&&alarm.lowRmet)wc=' warning';}
        html+=`<span class="role-chip ${cc}${wc}">${info.count}x ${r}</span>`;
    });
    html+='</div>';
    if(check&&alarm&&data.total>0&&(alarm.lowSrme||alarm.lowRmet)){
        html+=`<div style="font-size:0.65rem;color:#e74c3c;margin-top:4px;">`;
        if(alarm.lowSrme)html+=`‚ö†Ô∏è Faltan SRME (${data.srmeCount||0}/${MIN_SRME_PER_SHIFT}) `;
        if(alarm.lowRmet)html+=`‚ö†Ô∏è Faltan RMET (${data.rmetCount||0}/${MIN_RMET_PER_SHIFT})`;
        html+=`</div>`;
    }
    return html;
}

function generateAbsenceBreakdown(ad){
    if(ad.total===0)return'<span style="color:#999;">Sin ausencias</span>';
    const bt=ad.byType;let html='<div class="role-summary">';
    if(bt.vac.length)html+=`<span class="role-chip" style="background:#ffcdd2;color:#c62828;">${bt.vac.length} Vacaciones</span>`;
    if(bt.ap.length)html+=`<span class="role-chip" style="background:#c8e6c9;color:#2e7d32;">${bt.ap.length} A. Propios</span>`;
    if(bt.tr.length)html+=`<span class="role-chip" style="background:#ffe0b2;color:#e65100;">${bt.tr.length} Formaci√≥n</span>`;
    if(bt.baja.length)html+=`<span class="role-chip" style="background:#e0e0e0;color:#424242;">${bt.baja.length} Baja</span>`;
    html+='</div>';return html;
}

function renderEmployeeList(employees,type){
    if(employees.length===0)return'<div class="no-employees">Sin personal asignado</div>';
    return employees.map(emp=>{
        let rc='role-other';if(emp.roleType==='srme')rc='role-srme';else if(emp.roleType==='rmet')rc='role-rmet';else if((emp.role||'').toUpperCase().includes('APP'))rc='role-app';else if(isManagerRole(emp.role))rc='role-manager';
        const oc=isManager?`onclick="selectEmployeeFromModal('${emp.login}')"`:'';
        const cs=isManager?'cursor:pointer;':'cursor:default;';
        return`<div class="employee-item" ${oc} style="${cs}"><div style="display:flex;flex-direction:column;align-items:flex-start;"><div style="display:flex;align-items:center;flex-wrap:wrap;gap:3px;"><span class="name">${emp.name}</span><span class="crew">${emp.crew}</span></div><span class="role-detail ${rc}">${emp.role||'Sin rol'}</span></div><span class="shift-badge ${type}">${emp.shift}</span></div>`;
    }).join('');
}

function renderAbsentList(employees){
    if(employees.length===0)return'<div class="no-employees">Sin ausencias registradas</div>';
    return employees.map(emp=>{
        let rc='role-other';if(emp.roleType==='srme')rc='role-srme';else if(emp.roleType==='rmet')rc='role-rmet';
        const oc=isManager?`onclick="selectEmployeeFromModal('${emp.login}')"`:'';
        const cs=isManager?'cursor:pointer;':'cursor:default;';
        return`<div class="employee-item" ${oc} style="${cs}"><div style="display:flex;flex-direction:column;align-items:flex-start;"><div style="display:flex;align-items:center;flex-wrap:wrap;gap:3px;"><span class="name">${emp.name}</span><span class="crew">${emp.crew}</span></div><span class="role-detail ${rc}">${emp.role||'Sin rol'}</span></div><span class="absence-type ${emp.absenceType||''}">${emp.absenceLabel}</span></div>`;
    }).join('');
}

function selectEmployeeFromModal(login){if(!isManager)return;closeDayOverviewModal();document.getElementById('filterEmployee').value=login;selectEmployee();}
function closeDayOverviewModal(){document.getElementById('dayOverviewModal').classList.remove('active');}

// =====================================================
// CALENDARIO INDIVIDUAL
// =====================================================
function generateCalendar(){
    if(!selectedEmployee)return;
    let html='';for(let m=1;m<=12;m++)html+=generateMonth(m);
    document.getElementById('calendarGrid').innerHTML=html;
}

function generateMonth(month){
    let html=`<div class="month-card"><div class="month-header"><h2>${monthNames[month-1]}</h2></div><table class="calendar-table"><thead><tr><th>L</th><th>M</th><th>X</th><th>J</th><th>V</th><th>S</th><th>D</th></tr></thead><tbody>`;
    let day=1;
    const weeks=Math.ceil((daysInMonth[month-1]+startDays[month-1])/7);
    for(let w=0;w<weeks;w++){
        html+='<tr>';
        for(let d=0;d<7;d++){
            if((w===0&&d<startDays[month-1])||day>daysInMonth[month-1]){html+='<td class="empty"></td>';}
            else{
                const doy=getDayOfYear(month,day);const shift=(selectedEmployee.turnos[doy]||'').toLowerCase();
                const si=getShiftInfo(shift);const fest=isFestivo(month,day);const isOt=isOtFileDay(month,day);
                let classes=[],onclick=`openEditModal(${month},${day})`,extra='';
                if(isOt){
                    classes.push('ot-file-day');onclick=`openOtFileModal(${month},${day})`;extra=`<span class="shift-code">OT</span>`;
                    const otDay=getOtDay(doy);
                    if(otDay&&selectedEmployee){if(otDay.signups&&otDay.signups.some(s=>s.login===selectedEmployee.login))classes.push('user-signed');if(otDay.assignments&&['morning','afternoon','night'].some(sh=>otDay.assignments[sh]&&otDay.assignments[sh].some(a=>a.login===selectedEmployee.login)))classes.push('user-assigned');}
                } else {
                    classes.push(getShiftClass(shift));
                    let hd='';if(shift&&si.hours!=='-'){const hp=si.hours.split(' - ');if(hp.length===2)hd=`<span class="shift-hours">${hp[0].substring(0,5)}</span>`;}
                    extra=`<span class="shift-code">${shift?shift.toUpperCase():''}</span>${hd}`;
                }
                if(fest)classes.push('festivo');if(isReducido(shift))classes.push('reducido');
                html+=`<td class="${classes.join(' ')}" onclick="${onclick}"><span class="day-num">${day}</span>${extra}</td>`;day++;
            }
        }
        html+='</tr>';
    }
    html+='</tbody></table></div>';return html;
}

function getShiftClass(shift){
    if(!shift)return'libre';const s=shift.toLowerCase();
    if(s==='wm')return'shift-wm';if(s==='m8')return'shift-m8';if(s==='m')return'shift-m';if(s==='m-co')return'shift-m-co';
    if(s==='wt')return'shift-wt';if(s==='t8')return'shift-t8';if(s==='t')return'shift-t';if(s==='t-co')return'shift-t-co';
    if(s==='n8')return'shift-n8';if(s==='n'||s==='wn')return'shift-n';if(s==='nn')return'shift-nn';if(s==='n-co')return'shift-n-co';
    if(isCentralShift(s))return'shift-c';if(s==='v'||s==='v25'||s==='v26')return'shift-v';
    if(s.startsWith('ap'))return'shift-ap';if(s==='tr')return'shift-tr';if(s==='bm'||s==='bp')return'shift-bm';
    return'libre';
}

function generateStats(){
    if(!selectedEmployee)return;
    let st={wm:0,m8:0,wt:0,t8:0,n8:0,n:0,central:0,vacaciones:0,ap:0,ot:0};
    for(let doy=0;doy<365;doy++){
        const otDay=getOtDay(doy);
        if(otDay&&otDay.assignments&&['morning','afternoon','night'].some(sh=>otDay.assignments[sh]&&otDay.assignments[sh].some(a=>a.login===selectedEmployee.login))){st.ot++;continue;}
        const shift=(selectedEmployee.turnos[doy]||'').toLowerCase();
        if(shift==='wm')st.wm++;else if(shift==='m8'||shift==='m'||shift==='m-co')st.m8++;
        else if(shift==='wt')st.wt++;else if(shift==='t8'||shift==='t'||shift==='t-co')st.t8++;
        else if(shift==='n8')st.n8++;else if(shift==='n'||shift==='wn'||shift==='nn'||shift==='n-co')st.n++;
        else if(isCentralShift(shift))st.central++;else if(shift==='v'||shift==='v25'||shift==='v26')st.vacaciones++;
        else if(shift.startsWith('ap'))st.ap++;
    }
    const total=st.wm+st.m8+st.wt+st.t8+st.n8+st.n+st.central+st.ot;
    document.getElementById('statsGrid').innerHTML=`
    <div class="stat-card"><div class="stat-number" style="color:rgb(100,160,50)">${st.wm}</div><div class="stat-label">WM</div></div>
    <div class="stat-card"><div class="stat-number" style="color:rgb(100,160,50)">${st.m8}</div><div class="stat-label">M8</div></div>
    <div class="stat-card"><div class="stat-number" style="color:rgb(200,150,0)">${st.wt}</div><div class="stat-label">WT</div></div>
    <div class="stat-card"><div class="stat-number" style="color:rgb(200,150,0)">${st.t8}</div><div class="stat-label">T8</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--azul)">${st.n8}</div><div class="stat-label">N8</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--azul)">${st.n}</div><div class="stat-label">N</div></div>
    <div class="stat-card"><div class="stat-number" style="color:#888">${st.central}</div><div class="stat-label">CENTRAL</div></div>
    <div class="stat-card"><div class="stat-number" style="color:#9b59b6">${st.ot}</div><div class="stat-label">OT</div></div>
    <div class="stat-card"><div class="stat-number" style="color:red">${st.vacaciones}</div><div class="stat-label">VAC</div></div>
    <div class="stat-card"><div class="stat-number" style="color:var(--verde-fuerte)">${st.ap}</div><div class="stat-label">AP</div></div>
    <div class="stat-card"><div class="stat-number" style="color:#2ecc71">${total}</div><div class="stat-label">TOTAL</div></div>`;
}

// =====================================================
// EDICI√ìN TURNOS
// =====================================================
function openEditModal(month,day){
    if(!selectedEmployee)return;
    if(isOtFileDay(month,day)){openOtFileModal(month,day);return;}
    editingDay={month,day,doy:getDayOfYear(month,day)};
    const dow=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
    const date=new Date(2026,month-1,day);
    document.getElementById('modalTitle').textContent=`${dow[date.getDay()]} ${day} de ${monthNames[month-1]} 2026`;
    const fest=isFestivo(month,day);
    document.getElementById('festivoBadge').style.display=fest?'inline-block':'none';
    if(fest)document.getElementById('festivoBadge').textContent='üéâ '+getFestivoName(month,day);
    const shift=(selectedEmployee.turnos[editingDay.doy]||'').toLowerCase();
    const si=getShiftInfo(shift);
    const cb=document.getElementById('currentShiftBadge');const ct=document.getElementById('currentShiftTime');
    if(shift){cb.textContent=shift.toUpperCase();cb.style.background=getShiftColor(shift);cb.style.color=getShiftTextColor(shift);ct.innerHTML=`<strong>${si.hours}</strong><br><small>${si.desc}</small>`;}
    else{cb.textContent='LIBRE';cb.style.background='#f5f5f5';cb.style.color='#999';ct.innerHTML='<small>Sin turno asignado</small>';}
    document.getElementById('managerEditSection').style.display=isManager?'block':'none';
    document.getElementById('noManagerMessage').style.display=isManager?'none':'block';
    document.getElementById('editModal').classList.add('active');
}

function getShiftColor(shift){
    const s=shift.toLowerCase();
    if(['wm','m8','m'].includes(s))return'linear-gradient(135deg,var(--verde),#7cb342)';
    if(s==='m-co')return'linear-gradient(135deg,#c8e6c9,#a5d6a7)';
    if(['wt','t8','t'].includes(s))return'linear-gradient(135deg,var(--naranja),#ffa000)';
    if(s==='t-co')return'linear-gradient(135deg,#fff3cd,#ffe082)';
    if(s==='n8')return'linear-gradient(135deg,var(--azul),#1a237e)';
    if(['n','wn'].includes(s))return'linear-gradient(135deg,#303f9f,var(--azul))';
    if(s==='nn')return'linear-gradient(135deg,#5c6bc0,#3949ab)';
    if(s==='n-co')return'linear-gradient(135deg,#7986cb,#5c6bc0)';
    if(isCentralShift(s))return'linear-gradient(135deg,#e0e0e0,#bdbdbd)';
    if(['v','v25','v26'].includes(s))return'linear-gradient(135deg,#ef5350,#e53935)';
    if(s.startsWith('ap'))return'linear-gradient(135deg,var(--verde-fuerte),#00c853)';
    if(s==='tr')return'linear-gradient(135deg,#ff9800,#f57c00)';
    return'#f5f5f5';
}

function getShiftTextColor(shift){
    const s=shift.toLowerCase();
    if(['wm','m8','m','m-co'].includes(s))return'#1a5c1a';
    if(['wt','t8','t','t-co'].includes(s))return'#5a4000';
    if(['n8','n','nn','wn','n-co'].includes(s))return'white';
    if(isCentralShift(s))return'#444';
    if(['v','v25','v26'].includes(s)||s.startsWith('ap')||s==='tr')return'white';
    return'#999';
}

function closeModal(){document.getElementById('editModal').classList.remove('active');editingDay=null;}

async function setShift(newShift){
    if(!editingDay||!isManager||!selectedEmployee||!currentUser)return;
    const idx=allData.empleados.findIndex(e=>e.login===selectedEmployee.login);
    if(idx===-1){showNotification('‚ùå Error',true);return;}
    if(!Array.isArray(allData.empleados[idx].turnos))allData.empleados[idx].turnos=turnosStringToArray(allData.empleados[idx].turnos);
    allData.empleados[idx].turnos[editingDay.doy]=newShift;
    selectedEmployee=allData.empleados[idx];
    closeModal();showNotification('‚è≥ Guardando...');
    if(await saveToCloud()){generateCalendar();generateStats();showNotification('‚úÖ Turno guardado');}
    editingDay=null;
}

// =====================================================
// OT FILE
// =====================================================
function openOtFileModal(month,day){
    const doy=getDayOfYear(month,day);const otDay=getOtDay(doy);
    if(!otDay){showNotification('‚ùå No es un d√≠a OT FILE',true);return;}
    currentOtDay=otDay;
    const dow=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
    const date=new Date(2026,month-1,day);
    document.getElementById('otFileModalTitle').textContent=`üîß ${dow[date.getDay()]} ${day} de ${monthNames[month-1]} 2026`;
    document.getElementById('otFileName').textContent=otDay.name;
    document.getElementById('otFileDesc').textContent=otDay.notes||'Sin descripci√≥n';
    document.getElementById('otFileCreator').textContent=otDay.createdByName;
    const sb=document.getElementById('otFileStatus');
    if(otDay.status==='open'){sb.textContent='üü¢ Abierto';sb.className='ot-status-badge open';}
    else if(otDay.status==='assigned'){sb.textContent='üü° Asignado';sb.className='ot-status-badge assigned';}
    else{sb.textContent='‚ö´ Cerrado';sb.className='ot-status-badge closed';}
    const us=otDay.signups?otDay.signups.find(s=>s.login===currentUser.login):null;
    if(us){
        document.getElementById('currentUserSignup').style.display='block';
        document.getElementById('preferencesList').style.display='none';
        document.getElementById('otSignupComment').style.display='none';
        document.querySelector('#otSignupSection .btn-save').style.display='none';
        document.getElementById('btnCancelSignup').style.display='inline-block';
        const pn={morning:'‚òÄÔ∏è Ma√±ana',afternoon:'üåÖ Tarde',night:'üåô Noche'};
        let pt=us.preferences.map((p,i)=>`${i+1}¬∫: ${pn[p]||'-'}`).join(', ');
        if(us.comment)pt+=`<br>üí¨ ${us.comment}`;
        document.getElementById('currentUserPrefs').innerHTML=pt;
    } else {
        document.getElementById('currentUserSignup').style.display='none';
        document.getElementById('preferencesList').style.display='block';
        document.getElementById('otSignupComment').style.display='block';
        document.querySelector('#otSignupSection .btn-save').style.display='inline-block';
        document.getElementById('btnCancelSignup').style.display='none';
        document.getElementById('pref1').value='';document.getElementById('pref2').value='';document.getElementById('pref3').value='';
        document.getElementById('otSignupComment').value='';
    }
    document.getElementById('otSignupSection').style.display=otDay.status==='closed'?'none':'block';
    renderOtSignupsList(otDay);renderOtAssignments(otDay);
    document.getElementById('otFileModal').classList.add('active');
}

function closeOtFileModal(){document.getElementById('otFileModal').classList.remove('active');currentOtDay=null;}

async function submitOtSignup(){
    if(!currentOtDay||!currentUser)return;
    const p1=document.getElementById('pref1').value;
    if(!p1){showNotification('‚ùå Selecciona al menos tu 1¬™ preferencia',true);return;}
    const p2=document.getElementById('pref2').value;const p3=document.getElementById('pref3').value;
    const comment=document.getElementById('otSignupComment').value.trim();
    const prefs=[p1];if(p2&&p2!==p1)prefs.push(p2);if(p3&&p3!==p1&&p3!==p2)prefs.push(p3);
    const oi=allData.otDays.findIndex(ot=>ot.doy===currentOtDay.doy);if(oi===-1)return;
    if(!allData.otDays[oi].signups)allData.otDays[oi].signups=[];
    const ei=allData.otDays[oi].signups.findIndex(s=>s.login===currentUser.login);
    const sd={login:currentUser.login,name:currentUser.name,role:currentUser.role,crew:currentUser.crew,preferences:prefs,comment,timestamp:new Date().toISOString()};
    if(ei>=0)allData.otDays[oi].signups[ei]=sd;else allData.otDays[oi].signups.push(sd);
    showNotification('‚è≥ Guardando...');
    if(await saveToCloud()){currentOtDay=allData.otDays[oi];openOtFileModal(currentOtDay.month,currentOtDay.day);showNotification('‚úÖ Inscripci√≥n guardada');}
}

async function cancelOtSignup(){
    if(!currentOtDay||!currentUser)return;
    if(!confirm('¬øCancelar tu inscripci√≥n?'))return;
    const oi=allData.otDays.findIndex(ot=>ot.doy===currentOtDay.doy);if(oi===-1)return;
    if(allData.otDays[oi].signups)allData.otDays[oi].signups=allData.otDays[oi].signups.filter(s=>s.login!==currentUser.login);
    if(allData.otDays[oi].assignments)['morning','afternoon','night'].forEach(sh=>{if(allData.otDays[oi].assignments[sh])allData.otDays[oi].assignments[sh]=allData.otDays[oi].assignments[sh].filter(a=>a.login!==currentUser.login);});
    showNotification('‚è≥ Guardando...');
    if(await saveToCloud()){currentOtDay=allData.otDays[oi];openOtFileModal(currentOtDay.month,currentOtDay.day);showNotification('‚úÖ Inscripci√≥n cancelada');}
}

function renderOtSignupsList(otDay){
    const c=document.getElementById('otRequestsList');const sups=otDay.signups||[];
    document.getElementById('otSignupCount').textContent=sups.length;
    if(sups.length===0){c.innerHTML='<div class="no-employees">Nadie se ha apuntado todav√≠a</div>';return;}
    const pn={morning:'Ma√±ana',afternoon:'Tarde',night:'Noche'};const pc={morning:'morning',afternoon:'afternoon',night:'night'};
    c.innerHTML=sups.map(s=>{
        const prefs=s.preferences.map((p,i)=>`<span class="pref-tag ${pc[p]}">${i+1}¬∫ ${pn[p]}</span>`).join('');
        const time=new Date(s.timestamp).toLocaleString('es-ES',{day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
        let at=null;if(otDay.assignments)['morning','afternoon','night'].forEach(sh=>{if(otDay.assignments[sh]&&otDay.assignments[sh].some(a=>a.login===s.login))at=sh;});
        const ab=at?`<span class="pref-tag ${pc[at]}" style="margin-left:10px;">‚úÖ ${pn[at]}</span>`:'';
        return`<div class="ot-request-item"><div class="request-info"><div class="request-name">${s.name} <small>(${s.crew})</small>${ab}</div><div class="request-prefs">${prefs}</div>${s.comment?`<div style="font-size:0.75rem;color:#666;">üí¨ ${s.comment}</div>`:''}<div class="request-time">üìÖ ${time}</div></div></div>`;
    }).join('');
}

function renderOtAssignments(otDay){
    const sec=document.getElementById('otAssignmentsSection');const grid=document.getElementById('otAssignmentGrid');
    if(!otDay.assignments){sec.style.display='none';return;}
    const has=['morning','afternoon','night'].some(s=>otDay.assignments[s]&&otDay.assignments[s].length>0);
    if(!has){sec.style.display='none';return;}
    sec.style.display='block';
    const rc=(sh,title,cc)=>{const emp=otDay.assignments[sh]||[];return`<div class="ot-assignment-column"><div class="column-header ${cc}">${title}</div>${emp.length===0?'<div class="no-employees" style="padding:10px;">Vac√≠o</div>':emp.map(e=>`<div class="ot-assigned-item"><span>${e.name}</span></div>`).join('')}</div>`;};
    grid.innerHTML=`${rc('morning','‚òÄÔ∏è MA√ëANA','morning')}${rc('afternoon','üåÖ TARDE','afternoon')}${rc('night','üåô NOCHE','night')}`;
}

// =====================================================
// OT MANAGER
// =====================================================
function openOtManagerModal(){if(!isManager){showNotification('‚ùå Solo managers',true);return;}renderOtDaysList();populateOtDaySelect();document.getElementById('otManagerModal').classList.add('active');}
function closeOtManagerModal(){document.getElementById('otManagerModal').classList.remove('active');}
function switchOtPanel(p,btn){document.querySelectorAll('#otManagerModal .panel-nav-btn').forEach(b=>b.classList.remove('active'));document.querySelectorAll('#otManagerModal .panel-content').forEach(c=>c.classList.remove('active'));btn.classList.add('active');document.getElementById('ot-panel-'+p).classList.add('active');if(p==='list')renderOtDaysList();if(p==='assign')populateOtDaySelect();}

async function createOtDay(){
    if(!isManager)return;
    const di=document.getElementById('otNewDate').value;const nm=document.getElementById('otNewName').value.trim();const nt=document.getElementById('otNewNotes').value.trim();
    if(!di){showNotification('‚ùå Selecciona una fecha',true);return;}if(!nm){showNotification('‚ùå Introduce un nombre',true);return;}
    const date=new Date(di);if(date.getFullYear()!==2026){showNotification('‚ùå Solo fechas de 2026',true);return;}
    const month=date.getMonth()+1;const day=date.getDate();const doy=getDayOfYear(month,day);
    if(getOtDay(doy)){showNotification('‚ö†Ô∏è Ya existe un d√≠a OT en esa fecha',true);return;}
    const nod={doy,month,day,name:nm,notes:nt,createdBy:currentUser.login,createdByName:currentUser.name,createdAt:new Date().toISOString(),status:'open',signups:[],assignments:{morning:[],afternoon:[],night:[]}};
    if(!allData.otDays)allData.otDays=[];allData.otDays.push(nod);
    showNotification('‚è≥ Guardando...');
    if(await saveToCloud()){document.getElementById('otNewDate').value='';document.getElementById('otNewName').value='';document.getElementById('otNewNotes').value='';if(isGeneralView)generateGeneralCalendar();else if(selectedEmployee)generateCalendar();renderOtDaysList();showNotification('‚úÖ D√≠a OT FILE creado');}
}

async function deleteOtDay(doy){
    if(!isManager)return;if(!confirm('¬øEliminar este d√≠a OT FILE?'))return;
    allData.otDays=allData.otDays.filter(ot=>ot.doy!==doy);
    showNotification('‚è≥ Eliminando...');
    if(await saveToCloud()){if(isGeneralView)generateGeneralCalendar();else if(selectedEmployee)generateCalendar();renderOtDaysList();showNotification('‚úÖ D√≠a OT eliminado');}
}

function renderOtDaysList(){
    const c=document.getElementById('otDaysList');
    if(!allData.otDays||allData.otDays.length===0){c.innerHTML='<div style="text-align:center;color:#999;padding:30px;">No hay d√≠as OT FILE creados</div>';return;}
    c.innerHTML=[...allData.otDays].sort((a,b)=>a.doy-b.doy).map(ot=>{
        const st=ot.status==='open'?'üü¢ Abierto':ot.status==='assigned'?'üü° Asignado':'‚ö´ Cerrado';
        return`<div style="padding:12px;margin-bottom:8px;background:#f8f9fa;border-radius:8px;border-left:4px solid #9b59b6;"><div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:5px;"><span style="font-weight:700;color:#9b59b6;">üîß ${ot.name}</span><span style="font-size:0.75rem;color:#888;">${ot.day} de ${monthNames[ot.month-1]}</span></div><div style="font-size:0.85rem;color:#333;margin-top:5px;">${st} ¬∑ ${(ot.signups||[]).length} apuntados</div><div style="margin-top:8px;display:flex;gap:5px;"><button class="btn btn-small btn-ot" onclick="openOtFileModal(${ot.month},${ot.day});closeOtManagerModal();">üëÅÔ∏è Ver</button><button class="btn btn-small btn-danger" onclick="deleteOtDay(${ot.doy})">üóëÔ∏è Eliminar</button></div></div>`;
    }).join('');
}

function populateOtDaySelect(){
    const sel=document.getElementById('otSelectDay');sel.innerHTML='<option value="">-- Selecciona --</option>';
    if(!allData.otDays||allData.otDays.length===0)return;
    [...allData.otDays].sort((a,b)=>a.doy-b.doy).forEach(ot=>sel.innerHTML+=`<option value="${ot.doy}">${ot.day}/${ot.month} - ${ot.name} (${(ot.signups||[]).length} apuntados)</option>`);
}

function loadOtDayForAssignment(){
    const doy=parseInt(document.getElementById('otSelectDay').value);const panel=document.getElementById('otAssignmentPanel');
    if(!doy){panel.style.display='none';return;}
    const otDay=getOtDay(doy);if(!otDay){panel.style.display='none';return;}
    currentOtDay=otDay;panel.style.display='block';
    document.getElementById('assignOtName').textContent=otDay.name;
    document.getElementById('assignOtCount').textContent=(otDay.signups||[]).length;
    renderAssignmentRequestsList(otDay);renderAssignmentColumns(otDay);
}

function renderAssignmentRequestsList(otDay){
    const c=document.getElementById('otAssignRequestsList');const sups=otDay.signups||[];
    const un=sups.filter(s=>!otDay.assignments||!['morning','afternoon','night'].some(sh=>otDay.assignments[sh]&&otDay.assignments[sh].some(a=>a.login===s.login)));
    if(un.length===0){c.innerHTML='<div class="no-employees">Todos est√°n asignados</div>';return;}
    const pn={morning:'M',afternoon:'T',night:'N'};const pc={morning:'morning',afternoon:'afternoon',night:'night'};
    c.innerHTML=un.map(s=>{
        const prefs=s.preferences.map((p,i)=>`<span class="pref-tag ${pc[p]}">${i+1}¬∫${pn[p]}</span>`).join('');
        const btns=s.preferences.map(p=>`<button class="assign-btn ${pc[p]}" onclick="assignToShift('${s.login}','${p}')">‚Üí ${pn[p]}</button>`).join('');
        return`<div class="ot-request-item"><div class="request-info"><div class="request-name">${s.name}</div><div class="request-prefs">${prefs}</div></div><div class="request-actions">${btns}</div></div>`;
    }).join('');
}

function renderAssignmentColumns(otDay){
    ['morning','afternoon','night'].forEach(sh=>{
        const c=document.getElementById('assignList'+sh.charAt(0).toUpperCase()+sh.slice(1));
        const assigned=(otDay.assignments&&otDay.assignments[sh])?otDay.assignments[sh]:[];
        c.innerHTML=assigned.length===0?'<div class="no-employees" style="padding:10px;">Vac√≠o</div>':assigned.map(e=>`<div class="ot-assigned-item"><span>${e.name}</span><button class="remove-btn" onclick="removeFromShift('${e.login}','${sh}')">√ó</button></div>`).join('');
    });
}

function assignToShift(login,shift){
    if(!currentOtDay)return;const oi=allData.otDays.findIndex(ot=>ot.doy===currentOtDay.doy);if(oi===-1)return;
    const s=allData.otDays[oi].signups?.find(s=>s.login===login);if(!s)return;
    if(!allData.otDays[oi].assignments)allData.otDays[oi].assignments={morning:[],afternoon:[],night:[]};
    ['morning','afternoon','night'].forEach(sh=>{if(allData.otDays[oi].assignments[sh])allData.otDays[oi].assignments[sh]=allData.otDays[oi].assignments[sh].filter(a=>a.login!==login);});
    if(!allData.otDays[oi].assignments[shift])allData.otDays[oi].assignments[shift]=[];
    allData.otDays[oi].assignments[shift].push({login:s.login,name:s.name,role:s.role,crew:s.crew});
    currentOtDay=allData.otDays[oi];renderAssignmentRequestsList(currentOtDay);renderAssignmentColumns(currentOtDay);
}

function removeFromShift(login,shift){
    if(!currentOtDay)return;const oi=allData.otDays.findIndex(ot=>ot.doy===currentOtDay.doy);if(oi===-1)return;
    if(allData.otDays[oi].assignments&&allData.otDays[oi].assignments[shift])allData.otDays[oi].assignments[shift]=allData.otDays[oi].assignments[shift].filter(a=>a.login!==login);
    currentOtDay=allData.otDays[oi];renderAssignmentRequestsList(currentOtDay);renderAssignmentColumns(currentOtDay);
}

async function saveOtAssignments(){
    if(!currentOtDay)return;const oi=allData.otDays.findIndex(ot=>ot.doy===currentOtDay.doy);if(oi===-1)return;
    const has=allData.otDays[oi].assignments&&['morning','afternoon','night'].some(s=>allData.otDays[oi].assignments[s]&&allData.otDays[oi].assignments[s].length>0);
    if(has)allData.otDays[oi].status='assigned';
    showNotification('‚è≥ Guardando...');if(await saveToCloud())showNotification('‚úÖ Asignaciones guardadas');
}

// =====================================================
// VACACIONES
// =====================================================
function renderVacacionesSection(employee,isEditable=false){
    if(!employee)return'';
    const v={pa:parseFloat(employee.vacPendientesAnt)||0,ra:parseFloat(employee.vacRestantesAnt)||0,ca:parseFloat(employee.vacConsumidasAnt)||0,a26:parseFloat(employee.vacAsignadas2026)||0,r26:parseFloat(employee.vacRestantes2026)||0,c26:parseFloat(employee.vacConsumidas2026)||0,ap:parseFloat(employee.apConsumidos)||0};
    const tr=v.ra+v.r26,tc=v.ca+v.c26;
    const ec=isEditable?'editable':'';const oc=isEditable?`onclick="openVacacionesEditModal('${employee.login}')"`:'';
    return`<div class="vacaciones-section" id="vacacionesSection"><h3>üèñÔ∏è Vacaciones y Asuntos Propios ${isEditable?'<span style="font-size:0.7rem;opacity:0.7;">(clic para editar)</span>':''}</h3><div class="vac-subsection"><div class="vac-subsection-title">üìÖ A√±o Anterior (2025)</div><div class="vacaciones-grid"><div class="vac-card vac-anterior ${ec}" ${oc}><div class="vac-value">${formatVacNumber(v.pa)}</div><div class="vac-label">Pendientes<br>A√±o Anterior</div></div><div class="vac-card vac-anterior ${ec}" ${oc}><div class="vac-value">${formatVacNumber(v.ra)}</div><div class="vac-label">Restantes<br>A√±o Anterior</div></div><div class="vac-card vac-anterior ${ec}" ${oc}><div class="vac-value">${formatVacNumber(v.ca)}</div><div class="vac-label">Consumidas<br>del A√±o Anterior</div></div></div></div><div class="vac-subsection"><div class="vac-subsection-title">üóìÔ∏è A√±o Actual (2026)</div><div class="vacaciones-grid"><div class="vac-card vac-actual ${ec}" ${oc}><div class="vac-value">${formatVacNumber(v.a26)}</div><div class="vac-label">Asignadas<br>2026</div></div><div class="vac-card vac-actual ${ec}" ${oc}><div class="vac-value">${formatVacNumber(v.r26)}</div><div class="vac-label">Restantes<br>2026</div></div><div class="vac-card vac-actual ${ec}" ${oc}><div class="vac-value">${formatVacNumber(v.c26)}</div><div class="vac-label">Consumidas<br>2026</div></div></div></div><div class="vac-subsection"><div class="vac-subsection-title">üìä Resumen Total</div><div class="vacaciones-grid"><div class="vac-card vac-total"><div class="vac-value">${formatVacNumber(tr)}</div><div class="vac-label">Total<br>Restantes</div></div><div class="vac-card vac-total"><div class="vac-value">${formatVacNumber(tc)}</div><div class="vac-label">Total<br>Consumidas</div></div><div class="vac-card vac-ap ${ec}" ${oc}><div class="vac-value">${formatVacNumber(v.ap)}</div><div class="vac-label">Asuntos Propios<br>Consumidos</div></div></div></div></div>`;
}

function updateVacacionesDisplay(){
    if(!selectedEmployee)return;
    const ex=document.getElementById('vacacionesSection');if(ex)ex.remove();
    const sc=document.getElementById('statsContainer');
    if(sc)sc.insertAdjacentHTML('beforebegin',renderVacacionesSection(selectedEmployee,isManager));
}

function openVacacionesEditModal(login){
    if(!isManager)return;const emp=allData.empleados.find(e=>e.login===login);if(!emp)return;
    editingVacacionesEmployee=emp;
    document.getElementById('vacEditEmployeeName').textContent=emp.name;
    document.getElementById('vacEditEmployeeLogin').textContent=emp.login;
    document.getElementById('vacEditPendientesAnt').value=emp.vacPendientesAnt||0;
    document.getElementById('vacEditRestantesAnt').value=emp.vacRestantesAnt||0;
    document.getElementById('vacEditConsumidasAnt').value=emp.vacConsumidasAnt||0;
    document.getElementById('vacEditAsignadas2026').value=emp.vacAsignadas2026||0;
    document.getElementById('vacEditRestantes2026').value=emp.vacRestantes2026||0;
    document.getElementById('vacEditConsumidas2026').value=emp.vacConsumidas2026||0;
    document.getElementById('vacEditApConsumidos').value=emp.apConsumidos||0;
    document.getElementById('editVacacionesModal').classList.add('active');
}

function closeVacacionesModal(){document.getElementById('editVacacionesModal').classList.remove('active');editingVacacionesEmployee=null;}

async function saveVacacionesEdit(){
    if(!editingVacacionesEmployee||!isManager)return;
    const idx=allData.empleados.findIndex(e=>e.login===editingVacacionesEmployee.login);if(idx===-1)return;
    Object.assign(allData.empleados[idx],{vacPendientesAnt:parseFloat(document.getElementById('vacEditPendientesAnt').value)||0,vacRestantesAnt:parseFloat(document.getElementById('vacEditRestantesAnt').value)||0,vacConsumidasAnt:parseFloat(document.getElementById('vacEditConsumidasAnt').value)||0,vacAsignadas2026:parseFloat(document.getElementById('vacEditAsignadas2026').value)||0,vacRestantes2026:parseFloat(document.getElementById('vacEditRestantes2026').value)||0,vacConsumidas2026:parseFloat(document.getElementById('vacEditConsumidas2026').value)||0,apConsumidos:parseFloat(document.getElementById('vacEditApConsumidos').value)||0});
    if(selectedEmployee&&selectedEmployee.login===editingVacacionesEmployee.login)selectedEmployee=allData.empleados[idx];
    closeVacacionesModal();showNotification('‚è≥ Guardando...');
    if(await saveToCloud()){updateVacacionesDisplay();showNotification('‚úÖ Vacaciones actualizadas');}
}

function filterVacacionesPanel(){renderVacacionesPanelTable();}

function renderVacacionesPanelTable(){
    const st=document.getElementById('vacPanelSearch')?.value.toLowerCase().trim()||'';
    const tb=document.getElementById('vacPanelBody');if(!tb)return;
    let emps=[...allData.empleados];
    if(st)emps=emps.filter(e=>e.name.toLowerCase().includes(st)||e.login.toLowerCase().includes(st)||e.crew.toLowerCase().includes(st));
    emps.sort((a,b)=>a.name.localeCompare(b.name));
    if(emps.length===0){tb.innerHTML='<tr><td colspan="8" style="text-align:center;color:#999;padding:20px;">No se encontraron empleados</td></tr>';return;}
    tb.innerHTML=emps.map(emp=>{
        const r26=parseFloat(emp.vacRestantes2026)||0;const ra=parseFloat(emp.vacRestantesAnt)||0;const tr=ra+r26;const wc=tr<=2?'warning':'';
        return`<tr><td class="emp-name">${emp.name}</td><td>${emp.crew}</td><td>${formatVacNumber(emp.vacPendientesAnt)}</td><td>${formatVacNumber(emp.vacRestantesAnt)}</td><td>${formatVacNumber(emp.vacAsignadas2026)}</td><td class="${wc}">${formatVacNumber(emp.vacRestantes2026)}</td><td>${formatVacNumber(emp.apConsumidos)}</td><td><button class="btn btn-small btn-save" onclick="openVacacionesEditFromPanel('${emp.login}')">‚úèÔ∏è</button></td></tr>`;
    }).join('');
}

function openVacacionesEditFromPanel(login){closeManagerModal();setTimeout(()=>openVacacionesEditModal(login),200);}

// =====================================================
// PANEL MANAGER
// =====================================================
function openManagerModal(){
    if(!isManager||!currentUser){showNotification('‚ùå Solo managers',true);return;}
    document.getElementById('currentManagerName').textContent=currentUser.name;
    document.getElementById('currentManagerLogin').textContent=currentUser.login;
    document.getElementById('currentManagerRole').textContent=currentUser.role;
    document.getElementById('passwordUserSearch').value='';
    const vs=document.getElementById('vacPanelSearch');if(vs)vs.value='';
    filterPasswordUsers();updatePasswordSummary();updateDBSizeInfo();
    document.getElementById('passwordUserInfo').style.display='none';selectedPasswordUser=null;
    document.querySelectorAll('#managerModal .panel-nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('#managerModal .panel-content').forEach(p=>p.classList.remove('active'));
    document.querySelector('#managerModal .panel-nav-btn').classList.add('active');
    document.getElementById('panel-import').classList.add('active');
    document.getElementById('managerModal').classList.add('active');
}

function closeManagerModal(){document.getElementById('managerModal').classList.remove('active');}

function switchPanel(p,btn){
    document.querySelectorAll('#managerModal .panel-nav-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('#managerModal .panel-content').forEach(c=>c.classList.remove('active'));
    btn.classList.add('active');document.getElementById('panel-'+p).classList.add('active');
    if(p==='passwords'){filterPasswordUsers();updatePasswordSummary();}
    if(p==='vacaciones')renderVacacionesPanelTable();
    if(p==='herramientas')renderGeneralStats();
    if(p==='import')updateDBSizeInfo();
}

function renderGeneralStats(){
    const c=document.getElementById('generalStats');if(!c)return;
    const te=allData.empleados.length;const mg=allData.empleados.filter(e=>isManagerRole(e.role)).length;
    const sr=allData.empleados.filter(e=>classifyRole(e.role)==='srme').length;
    const rm=allData.empleados.filter(e=>classifyRole(e.role)==='rmet').length;
    const cr=[...new Set(allData.empleados.map(e=>e.crew))].length;
    const ot=allData.otDays?.length||0;
    c.innerHTML=`<div class="general-stat-card" style="border-left:4px solid #667eea;"><div class="stat-value" style="color:#667eea;">${te}</div><div class="stat-name">Total Empleados</div></div><div class="general-stat-card" style="border-left:4px solid #9b59b6;"><div class="stat-value" style="color:#9b59b6;">${mg}</div><div class="stat-name">Managers</div></div><div class="general-stat-card" style="border-left:4px solid #2e7d32;"><div class="stat-value" style="color:#2e7d32;">${sr}</div><div class="stat-name">SRME</div></div><div class="general-stat-card" style="border-left:4px solid #1565c0;"><div class="stat-value" style="color:#1565c0;">${rm}</div><div class="stat-name">RMET/T√©cnicos</div></div><div class="general-stat-card" style="border-left:4px solid #ff9800;"><div class="stat-value" style="color:#ff9800;">${cr}</div><div class="stat-name">Crews</div></div><div class="general-stat-card" style="border-left:4px solid #8e44ad;"><div class="stat-value" style="color:#8e44ad;">${ot}</div><div class="stat-name">D√≠as OT</div></div>`;
}

// =====================================================
// CONTRASE√ëAS
// =====================================================
function filterPasswordUsers(){
    const st=document.getElementById('passwordUserSearch')?.value.toLowerCase().trim()||'';
    const sel=document.getElementById('passwordUserSelect');sel.innerHTML='<option value="">-- Selecciona un usuario --</option>';
    if(!allData.empleados||!allData.empleados.length)return;
    let f=st?allData.empleados.filter(e=>e.name.toLowerCase().includes(st)||e.login.toLowerCase().includes(st)):[...allData.empleados];
    f.sort((a,b)=>a.name.localeCompare(b.name));
    f.forEach(emp=>{const hc=allData.userPasswords&&allData.userPasswords[emp.login];sel.innerHTML+=`<option value="${emp.login}">${emp.name}${hc?' üîê':' üîì'}</option>`;});
}

function showPasswordUserInfo(login){
    if(!login){document.getElementById('passwordUserInfo').style.display='none';selectedPasswordUser=null;return;}
    const u=allData.empleados.find(e=>e.login===login);if(!u){document.getElementById('passwordUserInfo').style.display='none';selectedPasswordUser=null;return;}
    selectedPasswordUser=u;
    document.getElementById('pwUserName').textContent=u.name;document.getElementById('pwUserLogin').textContent=u.login;
    document.getElementById('pwUserCrew').textContent=u.crew||'N/A';document.getElementById('pwUserRole').textContent=u.role||'Sin rol';
    const hc=allData.userPasswords&&allData.userPasswords[u.login];const se=document.getElementById('pwStatus');
    if(hc){se.textContent='üîê Personalizada';se.className='password-status custom';}else{se.textContent='üîì Por defecto (1234)';se.className='password-status default';}
    document.getElementById('passwordUserInfo').style.display='block';
}

async function resetUserPassword(){
    if(!selectedPasswordUser||!isManager)return;
    if(!confirm(`¬øResetear la contrase√±a de ${selectedPasswordUser.name} a "1234"?`))return;
    if(allData.userPasswords&&allData.userPasswords[selectedPasswordUser.login])delete allData.userPasswords[selectedPasswordUser.login];
    showNotification('‚è≥ Guardando...');
    if(await saveToCloud()){showPasswordUserInfo(selectedPasswordUser.login);updatePasswordSummary();filterPasswordUsers();showNotification('‚úÖ Contrase√±a reseteada a 1234');}
}

function setCustomPassword(){if(!selectedPasswordUser||!isManager)return;document.getElementById('customPwUserName').textContent=selectedPasswordUser.name;document.getElementById('customNewPassword1').value='';document.getElementById('customNewPassword2').value='';document.getElementById('customPasswordModal').classList.add('active');}
function closeCustomPasswordModal(){document.getElementById('customPasswordModal').classList.remove('active');}

async function confirmCustomPassword(){
    if(!selectedPasswordUser||!isManager)return;
    const p1=document.getElementById('customNewPassword1').value;const p2=document.getElementById('customNewPassword2').value;
    if(!p1||p1.length<4){showNotification('‚ùå M√≠nimo 4 caracteres',true);return;}if(p1!==p2){showNotification('‚ùå Las contrase√±as no coinciden',true);return;}
    if(!allData.userPasswords)allData.userPasswords={};allData.userPasswords[selectedPasswordUser.login]=p1;
    showNotification('‚è≥ Guardando...');
    if(await saveToCloud()){closeCustomPasswordModal();showPasswordUserInfo(selectedPasswordUser.login);updatePasswordSummary();filterPasswordUsers();showNotification('‚úÖ Contrase√±a actualizada');}
}

function updatePasswordSummary(){
    const c=document.getElementById('passwordSummary');if(!c)return;
    const tu=allData.empleados.length;const cp=allData.userPasswords?Object.keys(allData.userPasswords).length:0;
    c.innerHTML=`<div class="password-summary-item"><span class="label">üë• Total usuarios</span><span class="count">${tu}</span></div><div class="password-summary-item"><span class="label">üîì Con contrase√±a por defecto</span><span class="count" style="color:#856404;">${tu-cp}</span></div><div class="password-summary-item"><span class="label">üîê Con contrase√±a personalizada</span><span class="count" style="color:#155724;">${cp}</span></div>`;
}

// =====================================================
// CONFIGURACI√ìN USUARIO
// =====================================================
function openUserSettingsModal(){
    if(!currentUser)return;
    document.getElementById('settingsUserName').textContent=currentUser.name;document.getElementById('settingsUserLogin').textContent=currentUser.login;
    document.getElementById('settingsUserCrew').textContent=currentUser.crew||'N/A';document.getElementById('settingsUserRole').textContent=currentUser.role||'Sin rol';
    document.getElementById('userNewPassword1').value='';document.getElementById('userNewPassword2').value='';
    document.getElementById('userSettingsModal').classList.add('active');
}

function closeUserSettingsModal(){document.getElementById('userSettingsModal').classList.remove('active');}

async function changeUserPassword(){
    if(!currentUser)return;
    const p1=document.getElementById('userNewPassword1').value;const p2=document.getElementById('userNewPassword2').value;
    if(!p1||p1.length<4){showNotification('‚ùå M√≠nimo 4 caracteres',true);return;}if(p1!==p2){showNotification('‚ùå Las contrase√±as no coinciden',true);return;}
    if(!allData.userPasswords)allData.userPasswords={};allData.userPasswords[currentUser.login]=p1;
    showNotification('‚è≥ Guardando...');
    if(await saveToCloud()){document.getElementById('userNewPassword1').value='';document.getElementById('userNewPassword2').value='';showNotification('‚úÖ Contrase√±a actualizada');}
}

// =====================================================
// IMPORTACI√ìN
// =====================================================
async function processBulkImportClean(){
    if(!isManager){showNotification('‚ùå Solo managers pueden importar',true);return;}
    const data=document.getElementById('bulkImportData').value;
    if(!data.trim()){showNotification('‚ö†Ô∏è No hay datos',true);return;}
    const ne=parseRawData(data);if(ne.length===0){showNotification('‚ùå No se pudieron importar',true);return;}
    if(!confirm(`Se importar√°n ${ne.length} empleados.\n\n‚ö†Ô∏è TAMBI√âN SE LIMPIAR√Å:\n‚Ä¢ Solicitudes antiguas\n‚Ä¢ Historial de cambios\n\n¬øContinuar?`)){showNotification('‚ùå Importaci√≥n cancelada');return;}
    let ac=0,ag=0;
    ne.forEach(nuevo=>{
        const idx=allData.empleados.findIndex(e=>e.login===nuevo.login);
        if(idx>=0){
            ['vacPendientesAnt','vacRestantesAnt','vacConsumidasAnt','vacAsignadas2026','vacRestantes2026','vacConsumidas2026','apConsumidos'].forEach(k=>{if(!nuevo[k]&&allData.empleados[idx][k])nuevo[k]=allData.empleados[idx][k];});
            allData.empleados[idx]=nuevo;ac++;
        } else {allData.empleados.push(nuevo);ag++;}
    });
    delete allData.changelog;delete allData.solicitudes;
    showNotification('‚è≥ Guardando...');
    if(await saveToCloud()){initializeFilters();showMyCalendar();document.getElementById('bulkImportData').value='';document.getElementById('importPreview').innerHTML='';updateDBSizeInfo();showNotification(`‚úÖ ${ag} nuevos, ${ac} actualizados. BD limpiada.`);}
}

async function cleanDatabaseManual(){
    if(!isManager){showNotification('‚ùå Solo managers',true);return;}
    if(!confirm('‚ö†Ô∏è ¬øLimpiar la base de datos?\n\nSe eliminar√°n:\n‚Ä¢ Solicitudes antiguas\n‚Ä¢ Historial de cambios\n\nLos turnos, empleados, contrase√±as y OT se mantendr√°n.\n\n¬øContinuar?'))return;
    delete allData.changelog;delete allData.solicitudes;
    showNotification('‚è≥ Limpiando BD...');
    if(await saveToCloud()){updateDBSizeInfo();showNotification('‚úÖ Base de datos limpiada correctamente');}
}

function previewBulkImport(){
    const data=document.getElementById('bulkImportData').value;if(!data.trim()){showNotification('‚ö†Ô∏è No hay datos',true);return;}
    const emps=parseRawData(data);const prev=document.getElementById('importPreview');
    if(emps.length===0){prev.innerHTML='<p style="color:red;">‚ùå No se detectaron empleados</p>';return;}
    const mg=emps.filter(e=>isManagerRole(e.role));let html=`<p style="color:green;">‚úÖ ${emps.length} empleados (${mg.length} managers)</p>`;
    const cv=emps.filter(e=>e.vacAsignadas2026>0||e.vacPendientesAnt>0);if(cv.length>0)html+=`<p style="color:#00b894;">üèñÔ∏è ${cv.length} con datos de vacaciones</p>`;
    let ct=0;emps.forEach(n=>{const a=allData.empleados.find(e=>e.login===n.login);if(a){const ta=Array.isArray(a.turnos)?a.turnos:turnosStringToArray(a.turnos);for(let d=0;d<365;d++){if((ta[d]||'').toLowerCase().trim()!==(n.turnos[d]||'').toLowerCase().trim())ct++;}}});
    if(ct>0)html+=`<p style="color:#e67e22;">üîÑ ${ct} turnos cambiar√°n</p>`;
    html+='<ul>';emps.slice(0,8).forEach(e=>{const im=isManagerRole(e.role)?' üëë':'';const tc=e.turnos.filter(t=>t).length;const in2=!allData.empleados.find(a=>a.login===e.login);html+=`<li><strong>${e.name}</strong> (${e.role})${im}${in2?' <span style="color:#27ae60;">üÜï</span>':''} - ${tc} turnos</li>`;});
    if(emps.length>8)html+=`<li>... y ${emps.length-8} m√°s</li>`;
    html+=`</ul><p style="color:#e74c3c;font-weight:600;margin-top:10px;">‚ö†Ô∏è Al importar se limpiar√°n solicitudes e historial</p>`;
    prev.innerHTML=html;
}

// =====================================================
// IMPRESI√ìN / EXPORTACI√ìN
// =====================================================
function printCalendar(){
    if(!selectedEmployee){showNotification('‚ùå Primero ve a "Mi Calendario" o selecciona un empleado',true);return;}
    const pd=document.getElementById('printDate');if(pd)pd.textContent=new Date().toLocaleDateString('es-ES',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});
    setTimeout(()=>window.print(),300);
}

function exportData(){
    if(!allData.empleados.length){showNotification('‚ö†Ô∏è No hay datos',true);return;}
    const exp=allData.empleados.map(e=>({...e,turnos:turnosArrayToString(e.turnos)}));
    const blob=new Blob([JSON.stringify({empleados:exp,otDays:allData.otDays,exportedAt:new Date().toISOString(),exportedBy:currentUser?currentUser.name:'An√≥nimo'},null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`turnos_backup_${new Date().toISOString().slice(0,10)}.json`;a.click();
    showNotification('üì§ Exportado');
}

function exportToTSV(){
    if(!allData.empleados.length){showNotification('‚ö†Ô∏è No hay datos',true);return;}
    let tsv='CREW\tLOGIN\tNOMBRE\tROL\tVAC_PEND_ANT\tVAC_REST_ANT\tVAC_CONS_ANT\tVAC_ASIG_2026\tVAC_REST_2026\tVAC_CONS_2026\tAP_CONS';
    for(let i=1;i<=365;i++)tsv+=`\tDIA_${i}`;tsv+='\n';
    allData.empleados.forEach(emp=>{
        const t=Array.isArray(emp.turnos)?emp.turnos:turnosStringToArray(emp.turnos);
        tsv+=`${emp.crew}\t${emp.login}\t${emp.name}\t${emp.role||''}\t${emp.vacPendientesAnt||0}\t${emp.vacRestantesAnt||0}\t${emp.vacConsumidasAnt||0}\t${emp.vacAsignadas2026||0}\t${emp.vacRestantes2026||0}\t${emp.vacConsumidas2026||0}\t${emp.apConsumidos||0}`;
        t.forEach(x=>tsv+=`\t${x||''}`);tsv+='\n';
    });
    const blob=new Blob([tsv],{type:'text/tab-separated-values;charset=utf-8;'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download=`turnos_${new Date().toISOString().slice(0,10)}.tsv`;a.click();
    showNotification('üìä Exportado a TSV');
}

// =====================================================
// UI
// =====================================================
function setView(cols,btn){
    const g=document.getElementById('calendarGrid');g.className='calendar-grid';
    if(cols!==3)g.classList.add('cols-'+cols);
    document.querySelectorAll('.btn-view').forEach(b=>b.classList.remove('active'));btn.classList.add('active');
}

// =====================================================
// ‚òÖ‚òÖ‚òÖ ATTENDANCE SHEET v2 - AGRUPACI√ìN INTELIGENTE ‚òÖ‚òÖ‚òÖ
// =====================================================
const ATT_FIRST_MONDAY = new Date(2026, 0, 5);
const ATT_DAY_NAMES = ['LUNES','MARTES','MI√âRCOLES','JUEVES','VIERNES','S√ÅBADO','DOMINGO'];
const ATT_DAY_SHORT = ['Lun','Mar','Mi√©','Jue','Vie','S√°b','Dom'];

function attDateToDoy(date) {
    return Math.round((date - new Date(2026, 0, 1)) / 86400000);
}
function attFmt(d) {
    return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
}
function attFmt2(d) {
    return `${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}`;
}
function attShiftCat(shift) {
    if (!shift) return null;
    const s = shift.toLowerCase();
    if (s==='wm'||s==='m8'||s==='m'||s==='m-co') return 'manana';
    if (s==='wt'||s==='t8'||s==='t'||s==='t-co') return 'tarde';
    if (s==='n8'||s==='n'||s==='nn'||s==='n-co'||s==='wn') return 'noche';
    if (isCentralShift(s)) return 'central';

    return null;
}
function attGetShift(emp, doy) {
    if (doy < 0 || doy >= 365) return '';
    return (emp.turnos[doy] || '').toLowerCase();
}
function attIsOoto(shift) {
    if (!shift) return true;
    const s = shift.toLowerCase();
    return ['v','v25','v26','ap','bm','bp','tr'].includes(s) || s.startsWith('ap');
}

function attPopulateWeeks() {
    const sel = document.getElementById('attWeekSel');
    sel.innerHTML = '<option value="">‚Äî Selecciona semana ‚Äî</option>';
    for (let w = 0; w < 53; w++) {
        const lunes = new Date(ATT_FIRST_MONDAY);
        lunes.setDate(ATT_FIRST_MONDAY.getDate() + w * 7);
        if (lunes.getFullYear() > 2026) break;
        const dom = new Date(lunes); dom.setDate(lunes.getDate() + 6);
        sel.innerHTML += `<option value="${w}">Sem ${w+1} ¬∑ ${attFmt2(lunes)} ‚Äì ${attFmt2(dom)}</option>`;
    }
}

// ‚îÄ‚îÄ Render helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function attRenderTable(list, opts = {}) {
    const { showDay = false, highlightLogins = null } = opts;
    if (!list.length)
        return `<div class="att-empty">‚Äî Sin personal en este grupo ‚Äî</div>`;
    list.sort((a, b) => a.name.localeCompare(b.name));
    return `<table class="att-table">
        <thead><tr>
            <th style="width:95px">Login</th>
            <th>Nombre Completo</th>
            <th style="width:90px">Grupo</th>
            <th style="width:80px">Rol</th>
            <th style="width:55px;text-align:center">Turno</th>
            ${showDay ? '<th style="width:50px">D√≠a</th>' : ''}
            <th style="width:140px">Firma</th>
        </tr></thead>
        <tbody>
        ${list.map(e => {
            const hl = highlightLogins && !highlightLogins.has(e.login)
                ? ' style="opacity:0.45;"' : '';
            return `<tr${hl}>
                <td><span class="att-td-login">${e.login}</span></td>
                <td><span class="att-td-name">${e.name}</span></td>
                <td><span class="att-td-crew">${e.crew}</span></td>
                <td><span class="att-td-role">${e.role||'‚Äî'}</span></td>
                <td class="att-td-shift">${e.shift}</td>
                ${showDay ? `<td class="att-td-day">${e.dayShort||''}</td>` : ''}
                <td class="att-firma-cell"><div class="att-firma-box"></div></td>
            </tr>`;
        }).join('')}
        </tbody></table>`;
}

function attRenderSection(headClass, icon, title, badge, list, opts) {
    return `<div class="att-section">
        <div class="att-sec-head ${headClass}">${icon} ${title}
            <span class="att-sec-badge">${badge}</span>
        </div>
        ${attRenderTable(list, opts)}
    </div>`;
}

// ‚îÄ‚îÄ Greedy set-cover: pick best days to cover employees ‚îÄ‚îÄ
function attFindOptimalSessions(employeeLogins, dayData, maxSessions = 3) {
    const sessions = [];
    const covered = new Set();
    const target = new Set(employeeLogins);

    while (covered.size < target.size && sessions.length < maxSessions) {
        let bestIdx = -1, bestNew = 0;
        dayData.forEach((dd, idx) => {
            const newCount = dd.employees.filter(e => target.has(e.login) && !covered.has(e.login)).length;
            if (newCount > bestNew) { bestNew = newCount; bestIdx = idx; }
        });
        if (bestIdx === -1 || bestNew === 0) break;

        const dd = dayData[bestIdx];
        const newEmps = dd.employees.filter(e => target.has(e.login) && !covered.has(e.login));
        newEmps.forEach(e => covered.add(e.login));

        sessions.push({
            dayIndex: dd.dayIndex,
            dayName: dd.dayName,
            date: dd.date,
            allEmployees: dd.employees.filter(e => target.has(e.login)),
            newEmployees: newEmps,
            newLogins: new Set(newEmps.map(e => e.login))
        });
    }

    const uncovered = [...target].filter(l => !covered.has(l));
    return { sessions, uncovered };
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MAIN BUILD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildAttendance() {
    if (!allData || !allData.empleados.length) return;
    const wi = parseInt(document.getElementById('attWeekSel').value);
    if (isNaN(wi)) return;

    // ‚îÄ‚îÄ Dates Mon-Sun ‚îÄ‚îÄ
    const lunes = new Date(ATT_FIRST_MONDAY);
    lunes.setDate(ATT_FIRST_MONDAY.getDate() + wi * 7);
    const diasSemana = [];
    for (let d = 0; d < 7; d++) {
        const dt = new Date(lunes); dt.setDate(lunes.getDate() + d);
        diasSemana.push(dt);
    }
    document.getElementById('attWeekLabel').textContent =
        `Semana ${wi+1} ¬∑ Lunes ${attFmt(lunes)} ‚Äî Domingo ${attFmt(diasSemana[6])}`;

    // ‚îÄ‚îÄ Step 1: Weekly schedule per employee ‚îÄ‚îÄ
    const weeklyData = allData.empleados.map(emp => {
        const days = diasSemana.map(dt => {
            const doy = attDateToDoy(dt);
            const raw = attGetShift(emp, doy);
            return { shift: raw.toUpperCase(), cat: attShiftCat(raw), isOoto: attIsOoto(raw) };
        });
        return { emp, days };
    });

    // ‚îÄ‚îÄ Step 2: OOTO = no working shift any day ‚îÄ‚îÄ
    const ootoList = [];
    const activeList = [];
    weeklyData.forEach(wd => {
        const hasWork = wd.days.some(d => d.cat !== null);
        if (hasWork) activeList.push(wd);
        else ootoList.push(wd);
    });

    // ‚îÄ‚îÄ Step 3: Monday meeting ‚Äî Ma√±ana / Tarde / Central ‚îÄ‚îÄ
    const mondayM = [], mondayT = [], mondayC = [];
    const mondayLogins = new Set();

    activeList.forEach(wd => {
        const mc = wd.days[0].cat;
        if (!mc || mc === 'noche') return;
        const entry = {
            login: wd.emp.login, name: wd.emp.name,
            crew: wd.emp.crew, role: wd.emp.role,
            shift: wd.days[0].shift
        };
        mondayLogins.add(wd.emp.login);
        if (mc === 'manana') mondayM.push(entry);
        else if (mc === 'tarde') mondayT.push(entry);
        else if (mc === 'central') mondayC.push(entry);
    });

      // ‚îÄ‚îÄ Step 4: Night workers ‚Äî EXCLUDING those already covered on Monday ‚îÄ‚îÄ
    const nightWorkerLogins = new Set();
    activeList.forEach(wd => {
        if (mondayLogins.has(wd.emp.login)) return; // Ya cubierto el lunes
        if (wd.days.some(d => d.cat === 'noche')) nightWorkerLogins.add(wd.emp.login);
    });


    // Build night availability per day Tue-Sun (indices 1-6)
    const nightDayData = [];
    for (let di = 1; di <= 6; di++) {
        const emps = [];
        activeList.forEach(wd => {
            if (nightWorkerLogins.has(wd.emp.login) && wd.days[di].cat === 'noche') {
                emps.push({
                    login: wd.emp.login, name: wd.emp.name,
                    crew: wd.emp.crew, role: wd.emp.role,
                    shift: wd.days[di].shift
                });
            }
        });
        nightDayData.push({
            dayIndex: di, dayName: ATT_DAY_NAMES[di],
            date: diasSemana[di], employees: emps
        });
    }

    const nightResult = attFindOptimalSessions([...nightWorkerLogins], nightDayData, 3);

        // ‚îÄ‚îÄ Step 5: Remaining day workers (not Monday, not night-covered, not OOTO) ‚îÄ‚îÄ
    const nightCoveredLogins = new Set();
    nightResult.sessions.forEach(s => s.allEmployees.forEach(e => nightCoveredLogins.add(e.login)));
    
    const remainingDayLogins = new Set();
    activeList.forEach(wd => {
        if (mondayLogins.has(wd.emp.login)) return;       // Ya cubierto lunes
        if (nightCoveredLogins.has(wd.emp.login)) return;  // Ya cubierto en sesi√≥n noche
        const hasDay = wd.days.some((d, di) => di > 0 && d.cat && d.cat !== 'noche');
        if (hasDay) remainingDayLogins.add(wd.emp.login);
    });


    const dayDayData = [];
    for (let di = 1; di <= 6; di++) {
        const emps = [];
        activeList.forEach(wd => {
            if (remainingDayLogins.has(wd.emp.login) &&
                wd.days[di].cat && wd.days[di].cat !== 'noche') {
                emps.push({
                    login: wd.emp.login, name: wd.emp.name,
                    crew: wd.emp.crew, role: wd.emp.role,
                    shift: wd.days[di].shift
                });
            }
        });
        dayDayData.push({
            dayIndex: di, dayName: ATT_DAY_NAMES[di],
            date: diasSemana[di], employees: emps
        });
    }

    const dayResult = attFindOptimalSessions([...remainingDayLogins], dayDayData, 3);

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  RENDER HTML
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let html = '';

    // ‚îÄ‚îÄ Summary box ‚îÄ‚îÄ
    const totalActive = activeList.length;
    const totalSessions = 1 + nightResult.sessions.length + dayResult.sessions.length;
    html += `<div style="display:flex;flex-wrap:wrap;gap:10px;justify-content:center;margin-bottom:16px;">
        <div style="background:#e8f5e9;padding:10px 16px;border-radius:10px;text-align:center;min-width:100px;">
            <div style="font-size:1.6rem;font-weight:800;color:#2e7d32;">${totalActive}</div>
            <div style="font-size:0.7rem;color:#555;">Activos</div>
        </div>
        <div style="background:#fff3e0;padding:10px 16px;border-radius:10px;text-align:center;min-width:100px;">
            <div style="font-size:1.6rem;font-weight:800;color:#e65100;">${ootoList.length}</div>
            <div style="font-size:0.7rem;color:#555;">OOTO</div>
        </div>
        <div style="background:#e3f2fd;padding:10px 16px;border-radius:10px;text-align:center;min-width:100px;">
            <div style="font-size:1.6rem;font-weight:800;color:#1565c0;">${totalSessions}</div>
            <div style="font-size:0.7rem;color:#555;">Sesiones</div>
        </div>
        <div style="background:#f3e5f5;padding:10px 16px;border-radius:10px;text-align:center;min-width:100px;">
            <div style="font-size:1.6rem;font-weight:800;color:#7b1fa2;">${mondayLogins.size}</div>
            <div style="font-size:0.7rem;color:#555;">Lunes D√≠a</div>
        </div>
        <div style="background:#e0f2f1;padding:10px 16px;border-radius:10px;text-align:center;min-width:100px;">
            <div style="font-size:1.6rem;font-weight:800;color:#00695c;">${nightWorkerLogins.size}</div>
            <div style="font-size:0.7rem;color:#555;">Noche</div>
        </div>
        <div style="background:#fce4ec;padding:10px 16px;border-radius:10px;text-align:center;min-width:100px;">
            <div style="font-size:1.6rem;font-weight:800;color:#c62828;">${remainingDayLogins.size}</div>
            <div style="font-size:0.7rem;color:#555;">Incorp.</div>
        </div>
    </div>`;

    // ‚îÄ‚îÄ SESSION PLAN ‚îÄ‚îÄ
    html += `<div style="background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:14px 18px;border-radius:12px;margin-bottom:16px;">
        <h4 style="margin-bottom:10px;">üìã Plan de Sesiones de la Semana</h4>
        <div style="display:flex;flex-wrap:wrap;gap:8px;">
            <div style="background:rgba(255,255,255,0.2);padding:8px 14px;border-radius:8px;font-size:0.8rem;">
                <strong>‚ë† LUNES ${attFmt2(lunes)}</strong><br>
                <span style="opacity:0.9;">Ma√±ana + Tarde + Central (${mondayLogins.size} pers.)</span>
            </div>`;

    nightResult.sessions.forEach((s, i) => {
        html += `<div style="background:rgba(0,32,96,0.5);padding:8px 14px;border-radius:8px;font-size:0.8rem;">
            <strong>${String.fromCharCode(0x2461 + i)} ${s.dayName} ${attFmt2(s.date)} üåô</strong><br>
            <span style="opacity:0.9;">Noche (${s.allEmployees.length} pers.)</span>
        </div>`;
    });

    dayResult.sessions.forEach((s, i) => {
        html += `<div style="background:rgba(255,152,0,0.4);padding:8px 14px;border-radius:8px;font-size:0.8rem;">
            <strong>${String.fromCharCode(0x2461 + nightResult.sessions.length + i)} ${s.dayName} ${attFmt2(s.date)} ‚òÄÔ∏è</strong><br>
            <span style="opacity:0.9;">Incorporaciones (${s.allEmployees.length} pers.)</span>
        </div>`;
    });

    html += `</div></div>`;

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // SESI√ìN 1: LUNES
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    html += `<div class="att-info-box att-info-lunes">
        üìå <strong>SESI√ìN 1 ‚Äî Lunes ${attFmt(lunes)}</strong> ‚Äî
        Reuni√≥n de cambio de turno: Ma√±ana ¬∑ Tarde ¬∑ Central &nbsp;|&nbsp;
        ${mondayLogins.size} personas
    </div>`;

    html += attRenderSection('att-head-manana', 'üü¢', 'Turno Ma√±ana (WM / M8)',
        `LUNES ${attFmt2(lunes)} ¬∑ ${mondayM.length} persona${mondayM.length!==1?'s':''}`,
        mondayM, {});

    html += attRenderSection('att-head-tarde', 'üü°', 'Turno Tarde (WT / T8)',
        `LUNES ${attFmt2(lunes)} ¬∑ ${mondayT.length} persona${mondayT.length!==1?'s':''}`,
        mondayT, {});

    if (mondayC.length > 0) {
        html += attRenderSection('att-head-central', '‚¨ú', 'Central (C / CW)',
            `LUNES ${attFmt2(lunes)} ¬∑ ${mondayC.length} persona${mondayC.length!==1?'s':''}`,
            mondayC, {});
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // SESIONES NOCHE
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    nightResult.sessions.forEach((sess, idx) => {
        const sesNum = idx + 2;
        const isMultiple = nightResult.sessions.length > 1;
        const suffix = isMultiple ? ` (${idx+1}¬™ sesi√≥n noche)` : '';

        html += `<div class="att-info-box" style="background:#e8eaf6;color:#1a237e;border-color:#3949ab;margin-top:18px;">
            üåô <strong>SESI√ìN ${sesNum} ‚Äî ${sess.dayName} ${attFmt(sess.date)} Noche${suffix}</strong> ‚Äî
            ${sess.allEmployees.length} persona${sess.allEmployees.length!==1?'s':''}
            ${isMultiple ? `<br><span style="font-size:0.75rem;opacity:0.8;">‚ú® Nuevos en esta sesi√≥n: ${sess.newEmployees.length} ¬∑ Ya cubiertos en sesi√≥n anterior: ${sess.allEmployees.length - sess.newEmployees.length}</span>` : ''}
        </div>`;

        const hlLogins = isMultiple ? sess.newLogins : null;

        html += attRenderSection('att-head-noche', 'üåô', `Turno Noche${suffix}`,
            `${sess.dayName} ${attFmt2(sess.date)} ¬∑ ${sess.allEmployees.length} persona${sess.allEmployees.length!==1?'s':''}`,
            sess.allEmployees, { highlightLogins: hlLogins });
    });

    if (nightResult.uncovered.length > 0) {
        const uncNames = nightResult.uncovered.map(login => {
            const emp = allData.empleados.find(e => e.login === login);
            return emp ? emp.name : login;
        });
        html += `<div style="background:#ffebee;padding:10px 14px;border-radius:8px;margin-top:8px;font-size:0.8rem;color:#c62828;border-left:4px solid #e53935;">
            ‚ö†Ô∏è <strong>${nightResult.uncovered.length} trabajadores nocturnos no cubiertos:</strong> ${uncNames.join(', ')}
        </div>`;
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // SESIONES INCORPORACIONES (d√≠a)
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (dayResult.sessions.length > 0) {
        dayResult.sessions.forEach((sess, idx) => {
            const sesNum = 2 + nightResult.sessions.length + idx;
            const isMultiple = dayResult.sessions.length > 1;
            const suffix = isMultiple ? ` (${idx+1}¬™ sesi√≥n)` : '';

            html += `<div class="att-info-box att-info-otros" style="margin-top:18px;">
                üìÖ <strong>SESI√ìN ${sesNum} ‚Äî ${sess.dayName} ${attFmt(sess.date)} Incorporaciones${suffix}</strong> ‚Äî
                Personal que no estuvo el lunes.
                ${sess.allEmployees.length} persona${sess.allEmployees.length!==1?'s':''}
                ${isMultiple ? `<br><span style="font-size:0.75rem;opacity:0.8;">‚ú® Nuevos: ${sess.newEmployees.length} ¬∑ Ya cubiertos: ${sess.allEmployees.length - sess.newEmployees.length}</span>` : ''}
            </div>`;

            const hlLogins = isMultiple ? sess.newLogins : null;

            const mList = sess.allEmployees.filter(e => ['WM','M8','M','M-CO'].includes(e.shift));
            const tList = sess.allEmployees.filter(e => ['WT','T8','T','T-CO'].includes(e.shift));
            const cList = sess.allEmployees.filter(e => ['C','CW'].includes(e.shift));

            if (mList.length > 0)
                html += attRenderSection('att-head-manana', 'üü¢', `Ma√±ana${suffix}`,
                    `${sess.dayName} ${attFmt2(sess.date)} ¬∑ ${mList.length}`, mList, { highlightLogins: hlLogins });
            if (tList.length > 0)
                html += attRenderSection('att-head-tarde', 'üü°', `Tarde${suffix}`,
                    `${sess.dayName} ${attFmt2(sess.date)} ¬∑ ${tList.length}`, tList, { highlightLogins: hlLogins });
            if (cList.length > 0)
                html += attRenderSection('att-head-central', '‚¨ú', `Central${suffix}`,
                    `${sess.dayName} ${attFmt2(sess.date)} ¬∑ ${cList.length}`, cList, { highlightLogins: hlLogins });
        });

        if (dayResult.uncovered.length > 0) {
            const uncNames = dayResult.uncovered.map(login => {
                const emp = allData.empleados.find(e => e.login === login);
                return emp ? emp.name : login;
            });
            html += `<div style="background:#ffebee;padding:10px 14px;border-radius:8px;margin-top:8px;font-size:0.8rem;color:#c62828;border-left:4px solid #e53935;">
                ‚ö†Ô∏è <strong>${dayResult.uncovered.length} trabajadores diurnos no cubiertos:</strong> ${uncNames.join(', ')}
            </div>`;
        }
    }

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // OOTO
    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (ootoList.length > 0) {
        html += `<div style="margin-top:20px;border-top:2px dashed #ddd;padding-top:16px;">
            <div style="background:#f5f5f5;padding:12px 16px;border-radius:10px;border-left:4px solid #9e9e9e;">
                <h4 style="color:#666;margin-bottom:8px;">üè† OOTO ‚Äî No presentes esta semana (${ootoList.length})</h4>
                <div style="display:flex;flex-wrap:wrap;gap:6px;">
                    ${ootoList.map(wd => {
                        let reason = 'Ausente';
                        for (let d = 0; d < 7; d++) {
                            const s = wd.days[d].shift;
                            if (s) {
                                if (['V','V25','V26'].includes(s)) { reason = 'üèñÔ∏è Vac'; break; }
                                if (s === 'BM') { reason = 'üè• Baja'; break; }
                                if (s === 'BP') { reason = 'üë∂ Baja Pat.'; break; }
                                if (s === 'TR') { reason = 'üìö Form.'; break; }
                                if (s.startsWith('AP')) { reason = 'üìã AP'; break; }
                            }
                        }
                        return `<span style="background:white;padding:4px 10px;border-radius:6px;font-size:0.75rem;border:1px solid #ddd;">
                            <strong>${wd.emp.name}</strong>
                            <span style="color:#999;margin-left:4px;">${reason}</span>
                        </span>`;
                    }).join('')}
                </div>
            </div>
        </div>`;
    }

    // ‚îÄ‚îÄ Coverage check ‚îÄ‚îÄ
    const allCovered = new Set([...mondayLogins]);
    nightResult.sessions.forEach(s => s.allEmployees.forEach(e => allCovered.add(e.login)));
    dayResult.sessions.forEach(s => s.allEmployees.forEach(e => allCovered.add(e.login)));
    const totalCovered = allCovered.size;
    const coverPct = totalActive > 0 ? Math.round(totalCovered / totalActive * 100) : 0;

    html += `<div style="text-align:center;margin-top:16px;padding:12px;background:${coverPct===100?'#e8f5e9':'#fff3e0'};border-radius:10px;">
        <span style="font-size:1.1rem;font-weight:700;color:${coverPct===100?'#2e7d32':'#e65100'};">
            ${coverPct === 100 ? '‚úÖ' : '‚ö†Ô∏è'} Cobertura: ${totalCovered}/${totalActive} personas activas (${coverPct}%)
        </span>
    </div>`;

    document.getElementById('attBody').innerHTML = html;
}

function openAttendance() {
    if (!allData || !allData.empleados.length) {
        showNotification('‚ö†Ô∏è No hay datos cargados', true); return;
    }
    attPopulateWeeks();
    const hoy = new Date();
    if (hoy.getFullYear() === 2026) {
        const diff = Math.floor((hoy - ATT_FIRST_MONDAY) / 86400000);
        const wi = Math.max(0, Math.floor(diff / 7));
        document.getElementById('attWeekSel').value = wi;
        buildAttendance();
    }
    document.getElementById('attOverlay').classList.add('active');
}

function closeAttendance() {
    document.getElementById('attOverlay').classList.remove('active');
}

function printAttendance() {
    document.body.classList.add('att-printing');
    window.print();
    setTimeout(() => document.body.classList.remove('att-printing'), 800);
}

// =====================================================
// INIT
// =====================================================
initializeLogin();
</script>
</body>
</html>



